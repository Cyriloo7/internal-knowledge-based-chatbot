<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel - RAG Chatbot</title>
    <link
      rel="icon"
      type="image/svg+xml"
      href="{{ url_for('static', filename='icons/favicon.svg') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
  </head>
  <body>
    <div class="app-container">
      <nav class="sidebar">
        <div class="sidebar-header">
          <div class="logo-small" , style="width: 60px; height: 60px">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
              <rect x="2" y="28" width="6" height="12" rx="2" fill="#546E7A" />
              <rect x="56" y="28" width="6" height="12" rx="2" fill="#546E7A" />

              <rect x="6" y="10" width="52" height="46" rx="8" fill="#78909C" />

              <rect x="28" y="4" width="8" height="6" fill="#546E7A" />
              <circle cx="32" cy="4" r="4" fill="#EF5350" />

              <rect
                x="12"
                y="20"
                width="40"
                height="18"
                rx="4"
                fill="#263238"
              />

              <circle cx="24" cy="29" r="5" fill="#FFCA28" />
              <circle cx="40" cy="29" r="5" fill="#FFCA28" />

              <rect x="20" y="44" width="24" height="6" rx="1" fill="#263238" />
            </svg>
          </div>
          <h2>RAG Assistant</h2>
        </div>

        <ul class="nav-menu">
          <li>
            <a href="/dashboard">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <rect x="3" y="3" width="7" height="7"></rect>
                <rect x="14" y="3" width="7" height="7"></rect>
                <rect x="14" y="14" width="7" height="7"></rect>
                <rect x="3" y="14" width="7" height="7"></rect>
              </svg>
              Dashboard
            </a>
          </li>
          <li>
            <a href="/chat">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
                ></path>
              </svg>
              Chat
            </a>
          </li>
          <li class="active">
            <a href="/admin">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M12 2a10 10 0 1 0 10 10H12V2z"></path>
              </svg>
              Admin Panel
            </a>
          </li>
        </ul>

        <div class="sidebar-footer">
          <a href="/logout" class="btn-logout">Logout</a>
        </div>
      </nav>

      <main class="main-content">
        <div class="page-header">
          <h1>Admin Panel</h1>
          <button class="btn btn-primary" onclick="showAddUserModal()">
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Add New User
          </button>
        </div>

        <div class="admin-tabs">
          <button class="tab-button active" onclick="showTab('users')">
            Users Management
          </button>
          <button class="tab-button" onclick="showTab('documents')">
            Documents
          </button>
          <button class="tab-button" onclick="showTab('conversations')">
            Conversations
          </button>
          <button class="tab-button" onclick="showTab('chathistory')">
            Chat History
          </button>
        </div>

        <!-- Users Tab -->
        <div id="usersTab" class="tab-content active">
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Username</th>
                  <th>Email</th>
                  <th>Role</th>
                  <th>Status</th>
                  <th>Created</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="usersTableBody">
                {% for user in users %}
                <tr>
                  <td>{{ user.id }}</td>
                  <td><strong>{{ user.username }}</strong></td>
                  <td>{{ user.email }}</td>
                  <td>
                    <span class="badge badge-{{ user.role }}"
                      >{{ user.role }}</span
                    >
                  </td>
                  <td>
                    <span
                      class="status-badge {% if user.is_active %}status-active{% else %}status-inactive{% endif %}"
                    >
                      {{ 'Active' if user.is_active else 'Inactive' }}
                    </span>
                  </td>
                  <td>{{ user.created_at.strftime('%Y-%m-%d') }}</td>
                  <td>
                    <button
                      class="btn-icon"
                      onclick="editUser({{ user.id }})"
                      title="Edit"
                    >
                      <svg
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path
                          d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"
                        ></path>
                        <path
                          d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"
                        ></path>
                      </svg>
                    </button>
                    <button
                      class="btn-icon btn-danger"
                      onclick="deleteUser({{ user.id }})"
                      title="Delete"
                    >
                      <svg
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path
                          d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
                        ></path>
                      </svg>
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Documents Tab -->
        <div id="documentsTab" class="tab-content">
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Filename</th>
                  <th>Collection</th>
                  <th>Uploaded By</th>
                  <th>Uploaded At</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="documentsTableBody">
                {% for doc in documents %}
                <tr>
                  <td>{{ doc.id }}</td>
                  <td>{{ doc.filename }}</td>
                  <td>
                    <span class="badge badge-{{ doc.collection_name }}"
                      >{{ doc.collection_name }}</span
                    >
                  </td>
                  <td><strong>{{ doc.uploaded_by }}</strong></td>
                  <td>{{ doc.uploaded_at.strftime('%Y-%m-%d %H:%M') }}</td>
                  <td>
                    <button
                      class="btn-icon"
                      onclick="editDocument({{ doc.id }}, '{{ doc.filename }}', '{{ doc.collection_name }}')"
                      title="Edit"
                    >
                      <svg
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path
                          d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"
                        ></path>
                        <path
                          d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"
                        ></path>
                      </svg>
                    </button>
                    <button
                      class="btn-icon btn-danger"
                      onclick="deleteDocument({{ doc.id }})"
                      title="Delete"
                    >
                      <svg
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path
                          d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
                        ></path>
                      </svg>
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Conversations Tab -->
        <div id="conversationsTab" class="tab-content">
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>User</th>
                  <th>Title</th>
                  <th>Collection</th>
                  <th>Created</th>
                  <th>Last Updated</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for conv in conversations %}
                <tr>
                  <td>{{ conv.id }}</td>
                  <td><strong>{{ conv.user_id }}</strong></td>
                  <td>{{ conv.title }}</td>
                  <td>
                    <span class="badge badge-{{ conv.collection_name }}"
                      >{{ conv.collection_name }}</span
                    >
                  </td>
                  <td>{{ conv.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                  <td>{{ conv.updated_at.strftime('%Y-%m-%d %H:%M') }}</td>
                  <td>
                    <button
                      class="btn-icon"
                      onclick="viewConversation({{ conv.id }})"
                      title="View Details"
                    >
                      <svg
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path
                          d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"
                        ></path>
                        <circle cx="12" cy="12" r="3"></circle>
                      </svg>
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Chat History Tab -->
        <div id="chathistoryTab" class="tab-content">
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>User</th>
                  <th>Conversation ID</th>
                  <th>Message Preview</th>
                  <th>Collection</th>
                  <th>Timestamp</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for history in chat_history %}
                <tr>
                  <td>{{ history.id }}</td>
                  <td><strong>{{ history.user_id }}</strong></td>
                  <td>
                    {{ history.conversation_id if history.conversation_id else
                    'N/A' }}
                  </td>
                  <td
                    style="
                      max-width: 300px;
                      overflow: hidden;
                      text-overflow: ellipsis;
                      white-space: nowrap;
                    "
                  >
                    {{ history.message[:100] }}{% if history.message|length >
                    100 %}...{% endif %}
                  </td>
                  <td>
                    <span class="badge badge-{{ history.collection_name }}"
                      >{{ history.collection_name }}</span
                    >
                  </td>
                  <td>{{ history.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                  <td>
                    <button
                      class="btn-icon"
                      onclick="viewChatDetails({{ history.id }}, '{{ history.message|replace('\'', '\\')|replace('\n', '\\n') }}', '{{ history.response|replace('\'', '\\')|replace('\n', '\\n') }}')"
                      title="View Full Message"
                    >
                      <svg
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path
                          d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"
                        ></path>
                        <circle cx="12" cy="12" r="3"></circle>
                      </svg>
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </main>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal">
      <div class="modal-content">
        <span class="modal-close" onclick="closeAddUserModal()">&times;</span>
        <h2>Add New User</h2>
        <form id="addUserForm">
          <div class="form-group">
            <label for="newUsername">Username</label>
            <input type="text" id="newUsername" required />
          </div>
          <div class="form-group">
            <label for="newEmail">Email</label>
            <input type="email" id="newEmail" required />
          </div>
          <div class="form-group">
            <label for="newPassword">Password</label>
            <input type="password" id="newPassword" required />
          </div>
          <div class="form-group">
            <label for="newRole">Role</label>
            <select id="newRole">
              <option value="user">User</option>
              <option value="b-manager">B-Manager</option>
              <option value="a-manager">A-Manager</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <button type="submit" class="btn btn-primary">Create User</button>
        </form>
      </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal">
      <div class="modal-content">
        <span class="modal-close" onclick="closeEditUserModal()">&times;</span>
        <h2>Edit User</h2>
        <form id="editUserForm">
          <input type="hidden" id="editUserId" />
          <div class="form-group">
            <label for="editRole">Role</label>
            <select id="editRole">
              <option value="user">User</option>
              <option value="b-manager">B-Manager</option>
              <option value="a-manager">A-Manager</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <div class="form-group">
            <label>
              <input type="checkbox" id="editActive" />
              Account Active
            </label>
          </div>
          <button type="submit" class="btn btn-primary">Update User</button>
        </form>
      </div>
    </div>

    <!-- Edit Document Modal -->
    <div id="editDocumentModal" class="modal">
      <div class="modal-content">
        <span class="modal-close" onclick="closeEditDocumentModal()"
          >&times;</span
        >
        <h2>Edit Document</h2>
        <form id="editDocumentForm">
          <input type="hidden" id="editDocumentId" />
          <div class="form-group">
            <label for="editDocumentFilename">Filename</label>
            <input type="text" id="editDocumentFilename" required />
            <small
              style="
                color: var(--text-light);
                font-size: 13px;
                margin-top: 4px;
                display: block;
              "
            >
              Note: Only the display name will be updated. The actual file
              remains unchanged.
            </small>
          </div>
          <div class="form-group">
            <label for="editDocumentCollection">Collection</label>
            <select id="editDocumentCollection" required>
              <option value="level-1">Level 1 (General)</option>
              <option value="level-2">Level 2 (Team)</option>
              <option value="level-3">Level 3 (Department)</option>
              <option value="level-4">Level 4 (Organization)</option>
            </select>
          </div>
          <div class="form-group">
            <label>
              <input type="checkbox" id="reindexDocument" />
              Re-index document with new collection
            </label>
            <small
              style="
                color: var(--text-light);
                font-size: 13px;
                margin-top: 4px;
                display: block;
              "
            >
              Check this to move the document to a different collection. This
              will re-process the document.
            </small>
          </div>
          <button type="submit" class="btn btn-primary">Update Document</button>
        </form>
      </div>
    </div>

    <!-- Chat Details Modal -->
    <div id="chatDetailsModal" class="modal">
      <div class="modal-content">
        <span class="modal-close" onclick="closeChatDetailsModal()"
          >&times;</span
        >
        <h2>Chat Message Details</h2>
        <div style="margin-top: 20px">
          <h3 style="color: var(--primary); margin-bottom: 10px">
            User Message:
          </h3>
          <div
            style="
              background: var(--bg);
              padding: 15px;
              border-radius: 8px;
              margin-bottom: 20px;
              white-space: pre-wrap;
              word-wrap: break-word;
            "
          >
            <p id="chatDetailsMessage"></p>
          </div>

          <h3 style="color: var(--secondary); margin-bottom: 10px">
            AI Response:
          </h3>
          <div
            style="
              background: var(--bg);
              padding: 15px;
              border-radius: 8px;
              white-space: pre-wrap;
              word-wrap: break-word;
            "
          >
            <p id="chatDetailsResponse"></p>
          </div>
        </div>
      </div>
    </div>

    <style>
      /* Additional styles for admin panel */
      .modal-content h3 {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 10px;
      }

      .data-table td strong {
        color: var(--primary);
      }

      .data-table td[style*="max-width"] {
        font-size: 13px;
        color: var(--text-light);
      }

      /* Badge styles for collection levels */
      .badge {
        text-transform: uppercase;
        font-size: 11px;
        padding: 4px 10px;
      }

      /* Improved modal scrolling */
      .modal-content {
        max-height: 85vh;
      }
    </style>

    <script>
      function showTab(tabName) {
        document.querySelectorAll(".tab-content").forEach((tab) => {
          tab.classList.remove("active");
        });
        document.querySelectorAll(".tab-button").forEach((btn) => {
          btn.classList.remove("active");
        });

        document.getElementById(tabName + "Tab").classList.add("active");
        event.target.classList.add("active");
      }

      function showAddUserModal() {
        document.getElementById("addUserModal").style.display = "flex";
      }

      function closeAddUserModal() {
        document.getElementById("addUserModal").style.display = "none";
      }

      function closeEditUserModal() {
        document.getElementById("editUserModal").style.display = "none";
      }

      function closeEditDocumentModal() {
        document.getElementById("editDocumentModal").style.display = "none";
      }

      function closeChatDetailsModal() {
        document.getElementById("chatDetailsModal").style.display = "none";
      }

      function viewChatDetails(id, message, response) {
        document.getElementById("chatDetailsMessage").textContent = message;
        document.getElementById("chatDetailsResponse").textContent = response;
        document.getElementById("chatDetailsModal").style.display = "flex";
      }

      function viewConversation(conversationId) {
        window.location.href = `/chat?conversation_id=${conversationId}`;
      }

      // Add User
      document
        .getElementById("addUserForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const userData = {
            username: document.getElementById("newUsername").value,
            email: document.getElementById("newEmail").value,
            password: document.getElementById("newPassword").value,
            role: document.getElementById("newRole").value,
          };

          try {
            const response = await fetch("/api/users", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(userData),
            });

            const data = await response.json();

            if (response.ok) {
              alert("User created successfully!");
              location.reload();
            } else {
              alert("Error: " + data.error);
            }
          } catch (error) {
            alert("Error creating user");
          }
        });

      // Edit User
      function editUser(userId) {
        const row = event.target.closest("tr");
        const role = row.cells[3].textContent.trim();
        const isActive = row.cells[4].textContent.trim() === "Active";

        document.getElementById("editUserId").value = userId;
        document.getElementById("editRole").value = role;
        document.getElementById("editActive").checked = isActive;
        document.getElementById("editUserModal").style.display = "flex";
      }

      document
        .getElementById("editUserForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const userId = document.getElementById("editUserId").value;
          const userData = {
            role: document.getElementById("editRole").value,
            is_active: document.getElementById("editActive").checked,
          };

          try {
            const response = await fetch(`/api/users/${userId}`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(userData),
            });

            if (response.ok) {
              alert("User updated successfully!");
              location.reload();
            } else {
              alert("Error updating user");
            }
          } catch (error) {
            alert("Error updating user");
          }
        });

      // Delete User
      function deleteUser(userId) {
        if (!confirm("Are you sure you want to delete this user?")) {
          return;
        }

        fetch(`/api/users/${userId}`, {
          method: "DELETE",
        })
          .then((response) => {
            if (response.ok) {
              alert("User deleted successfully!");
              location.reload();
            } else {
              alert("Error deleting user");
            }
          })
          .catch((error) => {
            alert("Error deleting user");
          });
      }

      // Edit Document
      function editDocument(docId, filename, collection) {
        document.getElementById("editDocumentId").value = docId;
        document.getElementById("editDocumentFilename").value = filename;
        document.getElementById("editDocumentCollection").value = collection;
        document.getElementById("reindexDocument").checked = false;
        document.getElementById("editDocumentModal").style.display = "flex";
      }

      document
        .getElementById("editDocumentForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const docId = document.getElementById("editDocumentId").value;
          const documentData = {
            filename: document.getElementById("editDocumentFilename").value,
            collection_name: document.getElementById("editDocumentCollection")
              .value,
            reindex: document.getElementById("reindexDocument").checked,
          };

          try {
            const response = await fetch(`/api/documents/${docId}`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(documentData),
            });

            const data = await response.json();

            if (response.ok) {
              alert("Document updated successfully!");
              location.reload();
            } else {
              alert("Error: " + (data.error || "Failed to update document"));
            }
          } catch (error) {
            alert("Error updating document");
          }
        });

      // Delete Document
      function deleteDocument(docId) {
        if (
          !confirm(
            "Are you sure you want to delete this document? This will also remove it from the vector store."
          )
        ) {
          return;
        }

        fetch(`/api/documents/${docId}`, {
          method: "DELETE",
        })
          .then(async (response) => {
            const data = await response.json();
            if (response.ok) {
              alert("Document deleted successfully!");
              location.reload();
            } else {
              alert("Error: " + (data.error || "Failed to delete document"));
            }
          })
          .catch((error) => {
            alert("Error deleting document");
          });
      }

      // Close modals on outside click
      window.onclick = function (event) {
        if (event.target.classList.contains("modal")) {
          event.target.style.display = "none";
        }
      };
    </script>
  </body>
</html>
