<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel - benbot</title>
    <link
      rel="icon"
      type="image/svg+xml"
      href="{{ url_for('static', filename='icons/favicon.svg') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
  </head>
  <body>
    <div class="app-container">
      <nav class="sidebar">
        <div class="sidebar-header">
          <div class="sidebar-header-content">
            <div class="logo-small" , style="width: 60px; height: 60px">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
                <rect
                  x="2"
                  y="28"
                  width="6"
                  height="12"
                  rx="2"
                  fill="#546E7A"
                />
                <rect
                  x="56"
                  y="28"
                  width="6"
                  height="12"
                  rx="2"
                  fill="#546E7A"
                />

                <rect
                  x="6"
                  y="10"
                  width="52"
                  height="46"
                  rx="8"
                  fill="#78909C"
                />

                <rect x="28" y="4" width="8" height="6" fill="#546E7A" />
                <circle cx="32" cy="4" r="4" fill="#EF5350" />

                <rect
                  x="12"
                  y="20"
                  width="40"
                  height="18"
                  rx="4"
                  fill="#263238"
                />

                <circle cx="24" cy="29" r="5" fill="#FFCA28" />
                <circle cx="40" cy="29" r="5" fill="#FFCA28" />

                <rect
                  x="20"
                  y="44"
                  width="24"
                  height="6"
                  rx="1"
                  fill="#263238"
                />
              </svg>
            </div>
            <h2>benbot</h2>
          </div>
          <button
            class="sidebar-toggle-btn"
            id="sidebarToggle"
            onclick="toggleSidebar()"
            title="Toggle sidebar"
          >
            <svg
              id="sidebarToggleIcon"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <line x1="3" y1="12" x2="21" y2="12"></line>
              <line x1="3" y1="6" x2="21" y2="6"></line>
              <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
          </button>
        </div>

        <ul class="nav-menu">
          <li>
            <a href="/dashboard" title="Dashboard">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <rect x="3" y="3" width="7" height="7"></rect>
                <rect x="14" y="3" width="7" height="7"></rect>
                <rect x="14" y="14" width="7" height="7"></rect>
                <rect x="3" y="14" width="7" height="7"></rect>
              </svg>
              <span>Dashboard</span>
            </a>
          </li>
          <li>
            <a href="/chat" title="Chat">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
                ></path>
              </svg>
              <span>Chat</span>
            </a>
          </li>
          <li class="active">
            <a href="/admin" title="Admin Panel">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M12 2a10 10 0 1 0 10 10H12V2z"></path>
              </svg>
              <span>Admin Panel</span>
            </a>
          </li>
        </ul>

        <div class="sidebar-footer">
          <button
            class="theme-toggle"
            id="themeToggle"
            onclick="toggleTheme()"
            title="Toggle theme"
          >
            <svg
              id="themeIcon"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <circle cx="12" cy="12" r="5"></circle>
              <line x1="12" y1="1" x2="12" y2="3"></line>
              <line x1="12" y1="21" x2="12" y2="23"></line>
              <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
              <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
              <line x1="1" y1="12" x2="3" y2="12"></line>
              <line x1="21" y1="12" x2="23" y2="12"></line>
              <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
              <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
            </svg>
          </button>
          <a href="/logout" class="btn-logout">
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <polyline points="16 17 21 12 16 7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            <span>Logout</span>
          </a>
        </div>
      </nav>

      <main class="main-content">
        <div class="page-header">
          <div>
            <h1>Admin Panel</h1>
            <p style="color: var(--text-light); margin-top: 4px">
              Manage users, documents, and system data
            </p>
          </div>
          <button class="btn btn-primary" onclick="showAddUserModal()">
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Add New User
          </button>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-card-header">
              <span class="stat-card-title">Total Users</span>
              <div class="stat-card-icon">
                <svg
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                  <circle cx="9" cy="7" r="4"></circle>
                  <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                  <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
              </div>
            </div>
            <div class="stat-card-value" id="statUsers">{{ users|length }}</div>
            <div class="stat-card-change">All registered users</div>
          </div>
          <div class="stat-card">
            <div class="stat-card-header">
              <span class="stat-card-title">Documents</span>
              <div
                class="stat-card-icon"
                style="
                  background: var(--secondary-light);
                  color: var(--secondary);
                "
              >
                <svg
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path
                    d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
                  ></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                  <line x1="16" y1="13" x2="8" y2="13"></line>
                  <line x1="16" y1="17" x2="8" y2="17"></line>
                  <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
              </div>
            </div>
            <div class="stat-card-value" id="statDocuments">
              {{ documents|length }}
            </div>
            <div class="stat-card-change">Indexed documents</div>
          </div>
          <div class="stat-card">
            <div class="stat-card-header">
              <span class="stat-card-title">Conversations</span>
              <div
                class="stat-card-icon"
                style="background: var(--warning-light); color: var(--warning)"
              >
                <svg
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path
                    d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
                  ></path>
                </svg>
              </div>
            </div>
            <div class="stat-card-value" id="statConversations">
              {{ conversations|length }}
            </div>
            <div class="stat-card-change">Active conversations</div>
          </div>
          <div class="stat-card">
            <div class="stat-card-header">
              <span class="stat-card-title">Chat History</span>
              <div
                class="stat-card-icon"
                style="background: var(--danger-light); color: var(--danger)"
              >
                <svg
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path
                    d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"
                  ></path>
                  <circle cx="12" cy="10" r="3"></circle>
                </svg>
              </div>
            </div>
            <div class="stat-card-value" id="statHistory">
              {{ chat_history|length }}
            </div>
            <div class="stat-card-change">Recent messages</div>
          </div>
        </div>

        <div class="admin-tabs">
          <button class="tab-button active" onclick="showTab('users')">
            Users Management
          </button>
          <button class="tab-button" onclick="showTab('documents')">
            Documents
          </button>
          <button class="tab-button" onclick="showTab('conversations')">
            Conversations
          </button>
          <button class="tab-button" onclick="showTab('chathistory')">
            Chat History
          </button>
        </div>

        <!-- Users Tab -->
        <div id="usersTab" class="tab-content active">
          <div class="admin-controls">
            <div class="admin-search">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
              </svg>
              <input
                type="text"
                id="usersSearch"
                placeholder="Search users by name, email, or role..."
                oninput="filterTable('users')"
              />
            </div>
            <div class="admin-filters">
              <select
                class="filter-select"
                id="usersRoleFilter"
                onchange="filterTable('users')"
              >
                <option value="">All Roles</option>
                <option value="user">User</option>
                <option value="b-manager">B-Manager</option>
                <option value="a-manager">A-Manager</option>
                <option value="admin">Admin</option>
              </select>
              <select
                class="filter-select"
                id="usersStatusFilter"
                onchange="filterTable('users')"
              >
                <option value="">All Status</option>
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
              </select>
            </div>
            <div class="sort-controls">
              <button
                class="sort-btn"
                onclick="sortTable('users', 'id')"
                id="sortUsersId"
              >
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M3 6h18M7 12h10M11 18h2"></path>
                </svg>
                Sort
              </button>
            </div>
          </div>
          <div class="table-container">
            <table class="data-table" id="usersTable">
              <thead>
                <tr>
                  <th style="width: 60px;">#</th>
                  <th
                    class="table-header-sortable"
                    onclick="sortTable('users', 'id')"
                    data-column="id"
                  >
                    ID
                  </th>
                  <th
                    class="table-header-sortable"
                    onclick="sortTable('users', 'username')"
                    data-column="username"
                  >
                    Username
                  </th>
                  <th
                    class="table-header-sortable"
                    onclick="sortTable('users', 'email')"
                    data-column="email"
                  >
                    Email
                  </th>
                  <th
                    class="table-header-sortable"
                    onclick="sortTable('users', 'role')"
                    data-column="role"
                  >
                    Role
                  </th>
                  <th
                    class="table-header-sortable"
                    onclick="sortTable('users', 'status')"
                    data-column="status"
                  >
                    Status
                  </th>
                  <th
                    class="table-header-sortable"
                    onclick="sortTable('users', 'created')"
                    data-column="created"
                  >
                    Created
                  </th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="usersTableBody">
                {% for user in users %}
                <tr>
                  <td class="row-number">{{ loop.index }}</td>
                  <td>{{ user.id }}</td>
                  <td><strong>{{ user.username }}</strong></td>
                  <td>{{ user.email }}</td>
                  <td>
                    <span class="badge badge-{{ user.role }}"
                      >{{ user.role }}</span
                    >
                  </td>
                  <td>
                    <span
                      class="status-badge {% if user.is_active %}status-active{% else %}status-inactive{% endif %}"
                    >
                      {{ 'Active' if user.is_active else 'Inactive' }}
                    </span>
                  </td>
                  <td>{{ user.created_at.strftime('%Y-%m-%d') }}</td>
                  <td>
                    <button
                      class="btn-icon"
                      onclick="editUser({{ user.id }})"
                      title="Edit"
                    >
                      <svg
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path
                          d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"
                        ></path>
                        <path
                          d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"
                        ></path>
                      </svg>
                    </button>
                    <button
                      class="btn-icon btn-danger"
                      onclick="deleteUser({{ user.id }})"
                      title="Delete"
                    >
                      <svg
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path
                          d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
                        ></path>
                      </svg>
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Documents Tab -->
        <div id="documentsTab" class="tab-content">
          <div class="admin-controls">
            <div class="admin-search">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
              </svg>
              <input
                type="text"
                id="documentsSearch"
                placeholder="Search documents by filename or uploader..."
                oninput="filterTable('documents')"
              />
            </div>
            <div class="admin-filters">
              <select
                class="filter-select"
                id="documentsCollectionFilter"
                onchange="filterTable('documents')"
              >
                <option value="">All Collections</option>
                <option value="level-1">Level 1</option>
                <option value="level-2">Level 2</option>
                <option value="level-3">Level 3</option>
                <option value="level-4">Level 4</option>
              </select>
              <select
                class="filter-select"
                id="documentsCategoryFilter"
                onchange="filterTable('documents')"
              >
                <option value="">All Categories</option>
                <option value="0">Uncategorized</option>
                {% for category in categories %}
                <option value="{{ category.id }}">{{ category.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="table-container">
            <table class="data-table" id="documentsTable">
              <thead>
                <tr>
                  <th style="width: 60px;">#</th>
                  <th
                    class="table-header-sortable"
                    onclick="sortTable('documents', 'id')"
                    data-column="id"
                  >
                    ID
                  </th>
                  <th
                    class="table-header-sortable"
                    onclick="sortTable('documents', 'filename')"
                    data-column="filename"
                  >
                    Filename
                  </th>
                  <th
                    class="table-header-sortable"
                    onclick="sortTable('documents', 'collection')"
                    data-column="collection"
                  >
                    Collection
                  </th>
                  <th
                    class="table-header-sortable"
                    onclick="sortTable('documents', 'category')"
                    data-column="category"
                  >
                    Category
                  </th>
                  <th
                    class="table-header-sortable"
                    onclick="sortTable('documents', 'uploaded_by')"
                    data-column="uploaded_by"
                  >
                    Uploaded By
                  </th>
                  <th
                    class="table-header-sortable"
                    onclick="sortTable('documents', 'uploaded_at')"
                    data-column="uploaded_at"
                  >
                    Uploaded At
                  </th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="documentsTableBody">
                {% for doc in documents %}
                <tr>
                  <td class="row-number">{{ loop.index }}</td>
                  <td>{{ doc.id }}</td>
                  <td>{{ doc.filename }}</td>
                  <td>
                    <span class="badge badge-{{ doc.collection_name }}"
                      >{{ doc.collection_name }}</span
                    >
                  </td>
                  <td data-category-id="{% if doc.category %}{{ doc.category.id }}{% else %}0{% endif %}">
                    {% if doc.category %}
                    <span class="badge" style="background-color: {{ doc.category.color }}; color: white;">
                      {{ doc.category.name }}
                    </span>
                    {% else %}
                    <span class="badge" style="background-color: #6B7280; color: white;">Uncategorized</span>
                    {% endif %}
                  </td>
                  <td><strong>{{ doc.uploaded_by }}</strong></td>
                  <td>{{ doc.uploaded_at.strftime('%Y-%m-%d %H:%M') }}</td>
                  <td>
                    <button
                      class="btn-icon"
                      onclick="editDocument({{ doc.id }}, '{{ doc.filename }}', '{{ doc.collection_name }}')"
                      title="Edit"
                    >
                      <svg
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path
                          d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"
                        ></path>
                        <path
                          d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"
                        ></path>
                      </svg>
                    </button>
                    <button
                      class="btn-icon btn-danger"
                      onclick="deleteDocument({{ doc.id }})"
                      title="Delete"
                    >
                      <svg
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path
                          d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
                        ></path>
                      </svg>
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Conversations Tab -->
        <div id="conversationsTab" class="tab-content">
          <div class="admin-controls">
            <div class="admin-search">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
              </svg>
              <input
                type="text"
                id="conversationsSearch"
                placeholder="Search conversations by user or title..."
                oninput="filterTable('conversations')"
              />
            </div>
            <div class="admin-filters">
              <select
                class="filter-select"
                id="conversationsCollectionFilter"
                onchange="filterTable('conversations')"
              >
                <option value="">All Collections</option>
                <option value="level-1">Level 1</option>
                <option value="level-2">Level 2</option>
                <option value="level-3">Level 3</option>
                <option value="level-4">Level 4</option>
              </select>
            </div>
          </div>
          <div class="table-container">
            <table class="data-table" id="conversationsTable">
              <thead>
                <tr>
                  <th style="width: 60px;">#</th>
                  <th
                    class="table-header-sortable"
                    onclick="sortTable('conversations', 'id')"
                    data-column="id"
                  >
                    ID
                  </th>
                  <th
                    class="table-header-sortable"
                    onclick="sortTable('conversations', 'user')"
                    data-column="user"
                  >
                    User
                  </th>
                  <th
                    class="table-header-sortable"
                    onclick="sortTable('conversations', 'title')"
                    data-column="title"
                  >
                    Title
                  </th>
                  <th
                    class="table-header-sortable"
                    onclick="sortTable('conversations', 'collection')"
                    data-column="collection"
                  >
                    Collection
                  </th>
                  <th
                    class="table-header-sortable"
                    onclick="sortTable('conversations', 'created')"
                    data-column="created"
                  >
                    Created
                  </th>
                  <th
                    class="table-header-sortable"
                    onclick="sortTable('conversations', 'updated')"
                    data-column="updated"
                  >
                    Last Updated
                  </th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="conversationsTableBody">
                {% for conv in conversations %}
                <tr>
                  <td class="row-number">{{ loop.index }}</td>
                  <td>{{ conv.id }}</td>
                  <td><strong>{{ conv.user_id }}</strong></td>
                  <td>{{ conv.title }}</td>
                  <td>
                    <span class="badge badge-{{ conv.collection_name }}"
                      >{{ conv.collection_name }}</span
                    >
                  </td>
                  <td>{{ conv.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                  <td>{{ conv.updated_at.strftime('%Y-%m-%d %H:%M') }}</td>
                  <td>
                    <button
                      class="btn-icon"
                      onclick="viewConversation({{ conv.id }})"
                      title="View Details"
                    >
                      <svg
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path
                          d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"
                        ></path>
                        <circle cx="12" cy="12" r="3"></circle>
                      </svg>
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Chat History Tab -->
        <div id="chathistoryTab" class="tab-content">
          <div class="admin-controls">
            <div class="admin-search">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
              </svg>
              <input
                type="text"
                id="historySearch"
                placeholder="Search chat history by user or message..."
                oninput="filterTable('history')"
              />
            </div>
            <div class="admin-filters">
              <select
                class="filter-select"
                id="historyCollectionFilter"
                onchange="filterTable('history')"
              >
                <option value="">All Collections</option>
                <option value="level-1">Level 1</option>
                <option value="level-2">Level 2</option>
                <option value="level-3">Level 3</option>
                <option value="level-4">Level 4</option>
              </select>
            </div>
          </div>
          <div class="table-container">
            <table class="data-table" id="historyTable">
              <thead>
                <tr>
                  <th style="width: 60px;">#</th>
                  <th
                    class="table-header-sortable"
                    onclick="sortTable('history', 'id')"
                    data-column="id"
                  >
                    ID
                  </th>
                  <th
                    class="table-header-sortable"
                    onclick="sortTable('history', 'user')"
                    data-column="user"
                  >
                    User
                  </th>
                  <th
                    class="table-header-sortable"
                    onclick="sortTable('history', 'conversation_id')"
                    data-column="conversation_id"
                  >
                    Conversation ID
                  </th>
                  <th>Message Preview</th>
                  <th
                    class="table-header-sortable"
                    onclick="sortTable('history', 'collection')"
                    data-column="collection"
                  >
                    Collection
                  </th>
                  <th
                    class="table-header-sortable"
                    onclick="sortTable('history', 'timestamp')"
                    data-column="timestamp"
                  >
                    Timestamp
                  </th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="historyTableBody">
                {% for history in chat_history %}
                <tr>
                  <td class="row-number">{{ loop.index }}</td>
                  <td>{{ history.id }}</td>
                  <td><strong>{{ history.user_id }}</strong></td>
                  <td>
                    {{ history.conversation_id if history.conversation_id else
                    'N/A' }}
                  </td>
                  <td
                    style="
                      max-width: 300px;
                      overflow: hidden;
                      text-overflow: ellipsis;
                      white-space: nowrap;
                    "
                  >
                    {{ history.message[:100] }}{% if history.message|length >
                    100 %}...{% endif %}
                  </td>
                  <td>
                    <span class="badge badge-{{ history.collection_name }}"
                      >{{ history.collection_name }}</span
                    >
                  </td>
                  <td>{{ history.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                  <td>
                    <button
                      class="btn-icon"
                      onclick="viewChatDetails({{ history.id }}, '{{ history.message|replace('\'', '\\')|replace('\n', '\\n') }}', '{{ history.response|replace('\'', '\\')|replace('\n', '\\n') }}')"
                      title="View Full Message"
                    >
                      <svg
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path
                          d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"
                        ></path>
                        <circle cx="12" cy="12" r="3"></circle>
                      </svg>
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </main>

      <!-- Mobile Overlay -->
      <div
        class="mobile-overlay"
        id="mobileOverlay"
        onclick="closeAllMobileSidebars()"
      ></div>

      <!-- Mobile Bottom Navigation -->
      <nav class="mobile-bottom-nav">
        <a
          href="/dashboard"
          class="mobile-bottom-nav-item"
          id="mobileNavDashboard"
        >
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <rect x="3" y="3" width="7" height="7"></rect>
            <rect x="14" y="3" width="7" height="7"></rect>
            <rect x="14" y="14" width="7" height="7"></rect>
            <rect x="3" y="14" width="7" height="7"></rect>
          </svg>
          <span>Dashboard</span>
        </a>
        <a href="/chat" class="mobile-bottom-nav-item" id="mobileNavChat">
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
            ></path>
          </svg>
          <span>Chat</span>
        </a>
        <button
          class="mobile-bottom-nav-item"
          id="mobileNavMenu"
          onclick="toggleMobileSidebar()"
          style="border: none; background: none; cursor: pointer; width: 100%"
        >
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
          </svg>
          <span>Menu</span>
        </button>
        {% if user.role == 'admin' %}
        <a
          href="/admin"
          class="mobile-bottom-nav-item active"
          id="mobileNavAdmin"
        >
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
            <path d="M2 17l10 5 10-5"></path>
            <path d="M2 12l10 5 10-5"></path>
          </svg>
          <span>Admin</span>
        </a>
        {% endif %}
      </nav>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal">
      <div class="modal-content">
        <span class="modal-close" onclick="closeAddUserModal()">&times;</span>
        <h2>Add New User</h2>
        <form id="addUserForm">
          <div class="form-group">
            <label for="newUsername">Username</label>
            <input type="text" id="newUsername" required />
          </div>
          <div class="form-group">
            <label for="newEmail">Email</label>
            <input type="email" id="newEmail" required />
          </div>
          <div class="form-group">
            <label for="newPassword">Password</label>
            <input type="password" id="newPassword" required />
          </div>
          <div class="form-group">
            <label for="newRole">Role</label>
            <select id="newRole">
              <option value="user">User</option>
              <option value="b-manager">B-Manager</option>
              <option value="a-manager">A-Manager</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <button type="submit" class="btn btn-primary">Create User</button>
        </form>
      </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal">
      <div class="modal-content">
        <span class="modal-close" onclick="closeEditUserModal()">&times;</span>
        <h2>Edit User</h2>
        <form id="editUserForm">
          <input type="hidden" id="editUserId" />
          <div class="form-group">
            <label for="editRole">Role</label>
            <select id="editRole">
              <option value="user">User</option>
              <option value="b-manager">B-Manager</option>
              <option value="a-manager">A-Manager</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <div class="form-group">
            <label>
              <input type="checkbox" id="editActive" />
              Account Active
            </label>
          </div>
          <button type="submit" class="btn btn-primary">Update User</button>
        </form>
      </div>
    </div>

    <!-- Edit Document Modal -->
    <div id="editDocumentModal" class="modal">
      <div class="modal-content">
        <span class="modal-close" onclick="closeEditDocumentModal()"
          >&times;</span
        >
        <h2>Edit Document</h2>
        <form id="editDocumentForm">
          <input type="hidden" id="editDocumentId" />
          <div class="form-group">
            <label for="editDocumentFilename">Filename</label>
            <input type="text" id="editDocumentFilename" required />
            <small
              style="
                color: var(--text-light);
                font-size: 13px;
                margin-top: 4px;
                display: block;
              "
            >
              Note: Only the display name will be updated. The actual file
              remains unchanged.
            </small>
          </div>
          <div class="form-group">
            <label for="editDocumentCollection">Collection</label>
            <select
              id="editDocumentCollection"
              required
              onchange="handleCollectionChange()"
            >
              <option value="level-1">Level 1 (General)</option>
              <option value="level-2">Level 2 (Team)</option>
              <option value="level-3">Level 3 (Department)</option>
              <option value="level-4">Level 4 (Organization)</option>
            </select>
          </div>
          <div class="form-group">
            <label>
              <input type="checkbox" id="reindexDocument" checked />
              Re-index document with new collection
            </label>
            <small
              style="
                color: var(--text-light);
                font-size: 13px;
                margin-top: 4px;
                display: block;
              "
            >
              Automatically enabled when collection changes. This will
              re-process the document and update ChromaDB.
            </small>
          </div>
          <div id="reindexProgress" style="display: none; margin-top: 20px">
            <div
              style="
                display: flex;
                align-items: center;
                gap: 12px;
                margin-bottom: 8px;
              "
            >
              <div class="spinner-small" id="reindexSpinner"></div>
              <div style="flex: 1">
                <div
                  style="font-weight: 600; margin-bottom: 4px"
                  id="reindexStatus"
                >
                  Re-indexing document...
                </div>
                <div
                  class="progress-bar"
                  style="
                    height: 8px;
                    background: var(--bg-secondary);
                    border-radius: 4px;
                    overflow: hidden;
                  "
                >
                  <div
                    class="progress-fill"
                    id="reindexProgressFill"
                    style="
                      height: 100%;
                      background: linear-gradient(
                        90deg,
                        var(--primary),
                        var(--primary-dark)
                      );
                      width: 0%;
                      transition: width 0.3s ease;
                      border-radius: 4px;
                    "
                  ></div>
                </div>
                <div
                  style="
                    font-size: 12px;
                    color: var(--text-light);
                    margin-top: 4px;
                  "
                  id="reindexDetails"
                >
                  Preparing...
                </div>
              </div>
            </div>
          </div>
          <button type="submit" class="btn btn-primary" id="updateDocumentBtn">
            Update Document
          </button>
        </form>
      </div>
    </div>

    <!-- Chat Details Modal -->
    <div id="chatDetailsModal" class="modal">
      <div class="modal-content">
        <span class="modal-close" onclick="closeChatDetailsModal()"
          >&times;</span
        >
        <h2>Chat Message Details</h2>
        <div style="margin-top: 20px">
          <h3 style="color: var(--primary); margin-bottom: 10px">
            User Message:
          </h3>
          <div
            style="
              background: var(--bg);
              padding: 15px;
              border-radius: 8px;
              margin-bottom: 20px;
              white-space: pre-wrap;
              word-wrap: break-word;
            "
          >
            <p id="chatDetailsMessage"></p>
          </div>

          <h3 style="color: var(--secondary); margin-bottom: 10px">
            AI Response:
          </h3>
          <div
            style="
              background: var(--bg);
              padding: 15px;
              border-radius: 8px;
              white-space: pre-wrap;
              word-wrap: break-word;
            "
          >
            <p id="chatDetailsResponse"></p>
          </div>
        </div>
      </div>
    </div>

    <style>
      /* Additional styles for admin panel */
      .modal-content h3 {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 10px;
      }

      .data-table td strong {
        color: var(--primary);
      }

      .data-table td[style*="max-width"] {
        font-size: 13px;
        color: var(--text-light);
      }

      /* Badge styles for collection levels */
      .badge {
        text-transform: uppercase;
        font-size: 11px;
        padding: 4px 10px;
      }

      /* Improved modal scrolling */
      .modal-content {
        max-height: 85vh;
      }
    </style>

    <script>
      // Theme Management
      function initTheme() {
        const savedTheme = localStorage.getItem("theme") || "light";
        document.documentElement.setAttribute("data-theme", savedTheme);
        updateThemeIcon(savedTheme);
      }

      function toggleTheme() {
        const currentTheme =
          document.documentElement.getAttribute("data-theme") || "light";
        const newTheme = currentTheme === "light" ? "dark" : "light";
        document.documentElement.setAttribute("data-theme", newTheme);
        localStorage.setItem("theme", newTheme);
        updateThemeIcon(newTheme);
      }

      function updateThemeIcon(theme) {
        const icon = document.getElementById("themeIcon");
        if (!icon) return;

        if (theme === "dark") {
          icon.innerHTML = `
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
          `;
        } else {
          icon.innerHTML = `
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
          `;
        }
      }

      // Sidebar Toggle Management
      function initSidebar() {
        const savedState = localStorage.getItem("sidebarCollapsed");
        const sidebar = document.querySelector(".sidebar");
        if (savedState === "true" && sidebar) {
          sidebar.classList.add("collapsed");
        }
      }

      // Initialize theme and sidebar on page load
      initTheme();
      initSidebar();

      // Store original table data
      const tableData = {
        users: [],
        documents: [],
        conversations: [],
        history: [],
      };

      // Store current sort state
      const sortState = {
        users: { column: null, direction: "asc" },
        documents: { column: null, direction: "asc" },
        conversations: { column: null, direction: "asc" },
        history: { column: null, direction: "asc" },
      };

      // Initialize table data on page load
      document.addEventListener("DOMContentLoaded", function () {
        // Store original table rows
        tableData.users = Array.from(
          document.querySelectorAll("#usersTableBody tr")
        );
        tableData.documents = Array.from(
          document.querySelectorAll("#documentsTableBody tr")
        );
        tableData.conversations = Array.from(
          document.querySelectorAll("#conversationsTableBody tr")
        );
        tableData.history = Array.from(
          document.querySelectorAll("#historyTableBody tr")
        );
      });

      function showTab(tabName) {
        document.querySelectorAll(".tab-content").forEach((tab) => {
          tab.classList.remove("active");
        });
        document.querySelectorAll(".tab-button").forEach((btn) => {
          btn.classList.remove("active");
        });

        document.getElementById(tabName + "Tab").classList.add("active");
        if (event && event.target) {
          event.target.classList.add("active");
        } else {
          // If called programmatically, find the button and activate it
          const buttons = document.querySelectorAll(".tab-button");
          buttons.forEach((btn) => {
            if (btn.getAttribute("onclick") === `showTab('${tabName}')`) {
              btn.classList.add("active");
            }
          });
        }
        
        // Store active tab in sessionStorage
        sessionStorage.setItem('adminActiveTab', tabName);
      }
      
      // Restore active tab on page load
      function restoreActiveTab() {
        const savedTab = sessionStorage.getItem('adminActiveTab');
        if (savedTab) {
          // Small delay to ensure DOM is ready
          setTimeout(() => {
            showTab(savedTab);
          }, 100);
        }
      }
      
      // Run on both DOMContentLoaded and window load
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', restoreActiveTab);
      } else {
        restoreActiveTab();
      }
      window.addEventListener('load', restoreActiveTab);

      // Renumber rows in a table
      function renumberRows(tableType) {
        const tbody = document.getElementById(tableType + "TableBody");
        if (!tbody) return;
        
        const visibleRows = Array.from(tbody.querySelectorAll('tr:not([style*="display: none"])'));
        visibleRows.forEach((row, index) => {
          const rowNumberCell = row.querySelector('.row-number');
          if (rowNumberCell) {
            rowNumberCell.textContent = index + 1;
          }
        });
      }

      // Filter table function
      function filterTable(tableType) {
        const tbody = document.getElementById(tableType + "TableBody");
        if (!tbody) return;

        const searchInput =
          document.getElementById(tableType + "Search") ||
          document.getElementById(
            tableType === "history" ? "historySearch" : tableType + "sSearch"
          );
        const searchTerm = searchInput ? searchInput.value.toLowerCase() : "";

        let roleFilter = "";
        let statusFilter = "";
        let collectionFilter = "";
        let categoryFilter = "";

        if (tableType === "users") {
          roleFilter = document.getElementById("usersRoleFilter")?.value || "";
          statusFilter =
            document.getElementById("usersStatusFilter")?.value || "";
        } else if (tableType === "documents") {
          collectionFilter =
            document.getElementById("documentsCollectionFilter")?.value || "";
          categoryFilter =
            document.getElementById("documentsCategoryFilter")?.value || "";
        } else if (tableType === "conversations") {
          collectionFilter =
            document.getElementById("conversationsCollectionFilter")?.value ||
            "";
        } else if (tableType === "history") {
          collectionFilter =
            document.getElementById("historyCollectionFilter")?.value || "";
        }

        const rows = Array.from(tbody.querySelectorAll("tr"));
        let visibleCount = 0;

        rows.forEach((row) => {
          const cells = row.querySelectorAll("td");
          let visible = true;

          // Search filter
          if (searchTerm) {
            const rowText = Array.from(cells)
              .map((cell) => cell.textContent.toLowerCase())
              .join(" ");
            // For documents, also search in category name
            if (tableType === "documents") {
              const categoryCell = cells[4]; // Category is now at index 4 after "#" column
              if (categoryCell) {
                const categoryText = categoryCell.textContent.toLowerCase();
                const fullText = rowText + " " + categoryText;
                if (!fullText.includes(searchTerm)) {
                  visible = false;
                }
              } else if (!rowText.includes(searchTerm)) {
                visible = false;
              }
            } else if (!rowText.includes(searchTerm)) {
              visible = false;
            }
          }

          // Role filter (users only)
          if (tableType === "users" && roleFilter) {
            const roleCell = cells[4]?.textContent.trim().toLowerCase(); // Shifted by +1 for "#" column
            if (roleCell !== roleFilter.toLowerCase()) {
              visible = false;
            }
          }

          // Status filter (users only)
          if (tableType === "users" && statusFilter) {
            const statusCell = cells[5]?.textContent.trim().toLowerCase(); // Shifted by +1 for "#" column
            if (statusFilter === "active" && statusCell !== "active") {
              visible = false;
            } else if (
              statusFilter === "inactive" &&
              statusCell !== "inactive"
            ) {
              visible = false;
            }
          }

          // Collection filter
          if (collectionFilter) {
            let collectionCell = null;
            if (tableType === "documents") {
              collectionCell = cells[3]?.textContent.trim().toLowerCase(); // Shifted by +1
            } else if (tableType === "conversations") {
              collectionCell = cells[4]?.textContent.trim().toLowerCase(); // Shifted by +1
            } else if (tableType === "history") {
              collectionCell = cells[5]?.textContent.trim().toLowerCase(); // Shifted by +1
            }
            if (
              collectionCell &&
              !collectionCell.includes(collectionFilter.toLowerCase())
            ) {
              visible = false;
            }
          }

          // Category filter (documents only)
          if (tableType === "documents" && categoryFilter) {
            const categoryCell = cells[4]; // Category is now in the 5th column (index 4) after "#" column
            if (categoryCell) {
              const categoryId = categoryCell.getAttribute('data-category-id');
              // If filter is set and category ID doesn't match, hide the row
              // categoryId "0" means uncategorized
              if (categoryFilter === "0") {
                // Filter for uncategorized documents
                if (categoryId !== "0") {
                  visible = false;
                }
              } else {
                // Filter for specific category
                if (categoryId !== categoryFilter) {
                  visible = false;
                }
              }
            }
          }

          row.style.display = visible ? "" : "none";
          if (visible) visibleCount++;
        });

        // Renumber visible rows
        renumberRows(tableType);

        // Show empty state if no results
        showEmptyState(tbody, visibleCount === 0);
      }

      // Show/hide empty state
      function showEmptyState(tbody, isEmpty) {
        let emptyState = tbody.parentElement.querySelector(".empty-state");
        if (isEmpty && !emptyState) {
          emptyState = document.createElement("div");
          emptyState.className = "empty-state";
          emptyState.innerHTML = `
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
            <h3>No results found</h3>
            <p>Try adjusting your search or filter criteria</p>
          `;
          tbody.parentElement.appendChild(emptyState);
        } else if (!isEmpty && emptyState) {
          emptyState.remove();
        }
      }

      // Sort table function
      function sortTable(tableType, column) {
        const tbody = document.getElementById(tableType + "TableBody");
        if (!tbody) return;

        const state = sortState[tableType];
        const isAsc = state.column === column && state.direction === "asc";
        state.column = column;
        state.direction = isAsc ? "desc" : "asc";

        // Update header classes
        const headers = document.querySelectorAll(
          `#${tableType}Table .table-header-sortable`
        );
        headers.forEach((header) => {
          header.classList.remove("sort-asc", "sort-desc");
          if (header.dataset.column === column) {
            header.classList.add(isAsc ? "sort-desc" : "sort-asc");
          }
        });

        // Get visible rows
        const rows = Array.from(
          tbody.querySelectorAll('tr:not([style*="display: none"])')
        );

        rows.sort((a, b) => {
          let aVal, bVal;
          const aCells = a.querySelectorAll("td");
          const bCells = b.querySelectorAll("td");

          // Get values based on column (accounting for "#" column at index 0)
          if (tableType === "users") {
            switch (column) {
              case "id":
                aVal = parseInt(aCells[1]?.textContent); // ID is now at index 1
                bVal = parseInt(bCells[1]?.textContent);
                break;
              case "username":
                aVal = aCells[2]?.textContent.trim().toLowerCase(); // Shifted by +1
                bVal = bCells[2]?.textContent.trim().toLowerCase();
                break;
              case "email":
                aVal = aCells[3]?.textContent.trim().toLowerCase(); // Shifted by +1
                bVal = bCells[3]?.textContent.trim().toLowerCase();
                break;
              case "role":
                aVal = aCells[4]?.textContent.trim().toLowerCase(); // Shifted by +1
                bVal = bCells[4]?.textContent.trim().toLowerCase();
                break;
              case "status":
                aVal = aCells[5]?.textContent.trim().toLowerCase(); // Shifted by +1
                bVal = bCells[5]?.textContent.trim().toLowerCase();
                break;
              case "created":
                aVal = new Date(aCells[6]?.textContent); // Shifted by +1
                bVal = new Date(bCells[6]?.textContent);
                break;
              default:
                return 0;
            }
          } else if (tableType === "documents") {
            switch (column) {
              case "id":
                aVal = parseInt(aCells[1]?.textContent); // ID is now at index 1
                bVal = parseInt(bCells[1]?.textContent);
                break;
              case "filename":
                aVal = aCells[2]?.textContent.trim().toLowerCase(); // Shifted by +1
                bVal = bCells[2]?.textContent.trim().toLowerCase();
                break;
              case "collection":
                aVal = aCells[3]?.textContent.trim().toLowerCase(); // Shifted by +1
                bVal = bCells[3]?.textContent.trim().toLowerCase();
                break;
              case "category":
                aVal = aCells[4]?.textContent.trim().toLowerCase(); // Shifted by +1
                bVal = bCells[4]?.textContent.trim().toLowerCase();
                break;
              case "uploaded_by":
                aVal = aCells[5]?.textContent.trim().toLowerCase(); // Shifted by +1
                bVal = bCells[5]?.textContent.trim().toLowerCase();
                break;
              case "uploaded_at":
                aVal = new Date(aCells[6]?.textContent); // Shifted by +1
                bVal = new Date(bCells[6]?.textContent);
                break;
              default:
                return 0;
            }
          } else if (tableType === "conversations") {
            switch (column) {
              case "id":
                aVal = parseInt(aCells[1]?.textContent); // ID is now at index 1
                bVal = parseInt(bCells[1]?.textContent);
                break;
              case "user":
                aVal = aCells[2]?.textContent.trim().toLowerCase(); // Shifted by +1
                bVal = bCells[2]?.textContent.trim().toLowerCase();
                break;
              case "title":
                aVal = aCells[3]?.textContent.trim().toLowerCase(); // Shifted by +1
                bVal = bCells[3]?.textContent.trim().toLowerCase();
                break;
              case "collection":
                aVal = aCells[4]?.textContent.trim().toLowerCase(); // Shifted by +1
                bVal = bCells[4]?.textContent.trim().toLowerCase();
                break;
              case "created":
                aVal = new Date(aCells[5]?.textContent); // Shifted by +1
                bVal = new Date(bCells[5]?.textContent);
                break;
              case "updated":
                aVal = new Date(aCells[6]?.textContent); // Shifted by +1
                bVal = new Date(bCells[6]?.textContent);
                break;
              default:
                return 0;
            }
          } else if (tableType === "history") {
            switch (column) {
              case "id":
                aVal = parseInt(aCells[1]?.textContent); // ID is now at index 1
                bVal = parseInt(bCells[1]?.textContent);
                break;
              case "user":
                aVal = aCells[2]?.textContent.trim().toLowerCase(); // Shifted by +1
                bVal = bCells[2]?.textContent.trim().toLowerCase();
                break;
              case "conversation_id":
                aVal =
                  aCells[3]?.textContent.trim() === "N/A" // Shifted by +1
                    ? 0
                    : parseInt(aCells[3]?.textContent);
                bVal =
                  bCells[3]?.textContent.trim() === "N/A"
                    ? 0
                    : parseInt(bCells[3]?.textContent);
                break;
              case "collection":
                aVal = aCells[5]?.textContent.trim().toLowerCase(); // Shifted by +1
                bVal = bCells[5]?.textContent.trim().toLowerCase();
                break;
              case "timestamp":
                aVal = new Date(aCells[6]?.textContent); // Shifted by +1
                bVal = new Date(bCells[6]?.textContent);
                break;
              default:
                return 0;
            }
          }

          // Compare values
          if (aVal === bVal) return 0;
          if (aVal < bVal) return isAsc ? -1 : 1;
          return isAsc ? 1 : -1;
        });

        // Re-append sorted rows
        rows.forEach((row) => tbody.appendChild(row));
        
        // Renumber visible rows after sorting
        renumberRows(tableType);
      }

      function showAddUserModal() {
        document.getElementById("addUserModal").style.display = "flex";
      }

      function closeAddUserModal() {
        document.getElementById("addUserModal").style.display = "none";
      }

      function closeEditUserModal() {
        document.getElementById("editUserModal").style.display = "none";
      }

      function closeEditDocumentModal() {
        document.getElementById("editDocumentModal").style.display = "none";
      }

      function closeChatDetailsModal() {
        document.getElementById("chatDetailsModal").style.display = "none";
      }

      function viewChatDetails(id, message, response) {
        document.getElementById("chatDetailsMessage").textContent = message;
        document.getElementById("chatDetailsResponse").textContent = response;
        document.getElementById("chatDetailsModal").style.display = "flex";
      }

      function viewConversation(conversationId) {
        window.location.href = `/chat?conversation_id=${conversationId}`;
      }

      // Add User
      document
        .getElementById("addUserForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const userData = {
            username: document.getElementById("newUsername").value,
            email: document.getElementById("newEmail").value,
            password: document.getElementById("newPassword").value,
            role: document.getElementById("newRole").value,
          };

          try {
            const response = await fetch("/api/users", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(userData),
            });

            const data = await response.json();

            if (response.ok) {
              alert("User created successfully!");
              location.reload();
            } else {
              alert("Error: " + data.error);
            }
          } catch (error) {
            alert("Error creating user");
          }
        });

      // Edit User
      function editUser(userId) {
        const row = event.target.closest("tr");
        const role = row.cells[3].textContent.trim();
        const isActive = row.cells[4].textContent.trim() === "Active";

        document.getElementById("editUserId").value = userId;
        document.getElementById("editRole").value = role;
        document.getElementById("editActive").checked = isActive;
        document.getElementById("editUserModal").style.display = "flex";
      }

      document
        .getElementById("editUserForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const userId = document.getElementById("editUserId").value;
          const userData = {
            role: document.getElementById("editRole").value,
            is_active: document.getElementById("editActive").checked,
          };

          try {
            const response = await fetch(`/api/users/${userId}`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(userData),
            });

            if (response.ok) {
              alert("User updated successfully!");
              location.reload();
            } else {
              alert("Error updating user");
            }
          } catch (error) {
            alert("Error updating user");
          }
        });

      // Delete User
      function deleteUser(userId) {
        if (!confirm("Are you sure you want to delete this user?")) {
          return;
        }

        fetch(`/api/users/${userId}`, {
          method: "DELETE",
        })
          .then((response) => {
            if (response.ok) {
              alert("User deleted successfully!");
              location.reload();
            } else {
              alert("Error deleting user");
            }
          })
          .catch((error) => {
            alert("Error deleting user");
          });
      }

      // Edit Document
      let originalCollection = "";

      function editDocument(docId, filename, collection) {
        document.getElementById("editDocumentId").value = docId;
        document.getElementById("editDocumentFilename").value = filename;
        document.getElementById("editDocumentCollection").value = collection;
        originalCollection = collection;
        // Auto-enable re-index if collection will change
        document.getElementById("reindexDocument").checked = false;
        document.getElementById("reindexProgress").style.display = "none";
        document.getElementById("editDocumentModal").style.display = "flex";
      }

      function handleCollectionChange() {
        const newCollection = document.getElementById(
          "editDocumentCollection"
        ).value;
        const reindexCheckbox = document.getElementById("reindexDocument");

        // Auto-check re-index if collection changed
        if (newCollection !== originalCollection) {
          reindexCheckbox.checked = true;
        } else {
          reindexCheckbox.checked = false;
        }
      }

      document
        .getElementById("editDocumentForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const docId = document.getElementById("editDocumentId").value;
          const newCollection = document.getElementById(
            "editDocumentCollection"
          ).value;
          const reindex = document.getElementById("reindexDocument").checked;
          const documentData = {
            filename: document.getElementById("editDocumentFilename").value,
            collection_name: newCollection,
            reindex: reindex,
          };

          const updateBtn = document.getElementById("updateDocumentBtn");
          const progressDiv = document.getElementById("reindexProgress");
          const progressFill = document.getElementById("reindexProgressFill");
          const statusText = document.getElementById("reindexStatus");
          const detailsText = document.getElementById("reindexDetails");

          let progressInterval = null;

          // Show progress if re-indexing
          if (reindex && newCollection !== originalCollection) {
            progressDiv.style.display = "block";
            updateBtn.disabled = true;
            updateBtn.textContent = "Processing...";

            // Reset progress
            progressFill.style.width = "0%";
            statusText.textContent = "Re-indexing document...";
            detailsText.textContent = "Preparing...";

            // Simulate progress updates
            let progress = 0;
            progressInterval = setInterval(() => {
              progress += Math.random() * 15;
              if (progress > 90) progress = 90;
              progressFill.style.width = progress + "%";

              if (progress < 30) {
                statusText.textContent = "Re-indexing document...";
                detailsText.textContent = "Removing old chunks from ChromaDB";
              } else if (progress < 60) {
                statusText.textContent = "Re-indexing document...";
                detailsText.textContent = "Processing document content";
              } else if (progress < 90) {
                statusText.textContent = "Re-indexing document...";
                detailsText.textContent =
                  "Creating embeddings and updating vector store";
              }
            }, 300);
          }

          try {
            const response = await fetch(`/api/documents/${docId}`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(documentData),
            });

            const data = await response.json();

            if (reindex && newCollection !== originalCollection) {
              // Clear progress interval
              if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
              }

              // Complete progress
              progressFill.style.width = "100%";
              statusText.textContent = "Re-indexing complete!";
              detailsText.textContent =
                "Document successfully re-indexed in new collection";

              await new Promise((resolve) => setTimeout(resolve, 1000));
            }

            if (response.ok) {
              // Store current active tab before reload
              storeActiveTab();
              
              if (reindex && newCollection !== originalCollection) {
                alert("Document updated and re-indexed successfully!");
              } else {
                alert("Document updated successfully!");
              }
              location.reload();
            } else {
              if (reindex && newCollection !== originalCollection) {
                if (progressInterval) {
                  clearInterval(progressInterval);
                  progressInterval = null;
                }
                progressDiv.style.display = "none";
              }
              updateBtn.disabled = false;
              updateBtn.textContent = "Update Document";
              alert("Error: " + (data.error || "Failed to update document"));
            }
          } catch (error) {
            if (reindex && newCollection !== originalCollection) {
              if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
              }
              progressDiv.style.display = "none";
            }
            updateBtn.disabled = false;
            updateBtn.textContent = "Update Document";
            alert("Error updating document: " + error.message);
          }
        });

      // Helper function to store current active tab
      function storeActiveTab() {
        // First try to get from active tab button
        const activeTab = document.querySelector('.tab-button.active');
        if (activeTab) {
          const tabName = activeTab.getAttribute('onclick');
          if (tabName) {
            const match = tabName.match(/showTab\('(\w+)'\)/);
            if (match) {
              sessionStorage.setItem('adminActiveTab', match[1]);
              return;
            }
          }
        }
        // Fallback: check which tab content is active
        const activeTabContent = document.querySelector('.tab-content.active');
        if (activeTabContent) {
          const tabId = activeTabContent.id;
          const tabName = tabId.replace('Tab', '');
          sessionStorage.setItem('adminActiveTab', tabName);
        }
      }

      // Delete Document
      function deleteDocument(docId) {
        if (
          !confirm(
            "Are you sure you want to delete this document? This will also remove it from the vector store."
          )
        ) {
          return;
        }

        // Store current active tab before reload
        storeActiveTab();

        fetch(`/api/documents/${docId}`, {
          method: "DELETE",
        })
          .then(async (response) => {
            const data = await response.json();
            if (response.ok) {
              alert("Document deleted successfully!");
              location.reload();
            } else {
              alert("Error: " + (data.error || "Failed to delete document"));
            }
          })
          .catch((error) => {
            alert("Error deleting document");
          });
      }

      // Close modals on outside click
      window.onclick = function (event) {
        if (event.target.classList.contains("modal")) {
          event.target.style.display = "none";
        }
      };

      // Mobile sidebar functions
      function toggleMobileSidebar() {
        const sidebar = document.querySelector(".sidebar");
        const overlay = document.getElementById("mobileOverlay");

        if (!sidebar) {
          console.error("Sidebar element not found");
          return;
        }

        if (window.innerWidth <= 768) {
          const isOpening = !sidebar.classList.contains("open");

          // Remove collapsed class on mobile to ensure full width
          sidebar.classList.remove("collapsed");

          // Toggle open class
          sidebar.classList.toggle("open");

          // Show/hide overlay
          if (overlay) {
            if (isOpening) {
              overlay.classList.add("active");
            } else {
              overlay.classList.remove("active");
            }
          }

          // Force sidebar to be visible
          sidebar.style.display = "flex";
          sidebar.style.visibility = "visible";
          sidebar.style.opacity = "1";
        }
      }

      function closeAllMobileSidebars() {
        const sidebar = document.querySelector(".sidebar");
        const overlay = document.getElementById("mobileOverlay");

        if (sidebar) sidebar.classList.remove("open");
        if (overlay) overlay.classList.remove("active");
      }

      // Update active state in mobile bottom nav
      function updateMobileNavActive() {
        const currentPath = window.location.pathname;
        const navItems = document.querySelectorAll(".mobile-bottom-nav-item");
        navItems.forEach((item) => {
          item.classList.remove("active");
          if (item.getAttribute("href") === currentPath) {
            item.classList.add("active");
          }
        });
      }

      // Update mobile nav on page load
      updateMobileNavActive();

      // Prevent body scroll when sidebar is open on mobile
      function updateBodyScroll() {
        if (window.innerWidth <= 768) {
          const sidebar = document.querySelector(".sidebar");
          const isOpen = sidebar?.classList.contains("open");

          if (isOpen) {
            document.body.classList.add("sidebar-open");
          } else {
            document.body.classList.remove("sidebar-open");
          }
        } else {
          document.body.classList.remove("sidebar-open");
        }
      }

      // Watch for sidebar state changes
      const sidebarObserver = new MutationObserver(updateBodyScroll);
      const sidebar = document.querySelector(".sidebar");

      if (sidebar) {
        sidebarObserver.observe(sidebar, {
          attributes: true,
          attributeFilter: ["class"],
        });
      }

      // Desktop sidebar toggle
      function toggleSidebar() {
        const sidebar = document.querySelector(".sidebar");
        if (!sidebar) return;

        // Mobile handling
        if (window.innerWidth <= 768) {
          toggleMobileSidebar();
          return;
        }

        // Desktop handling
        sidebar.classList.toggle("collapsed");
        const isCollapsed = sidebar.classList.contains("collapsed");
        localStorage.setItem("sidebarCollapsed", isCollapsed);
      }

      // Close sidebar when clicking on nav menu items on mobile
      if (window.innerWidth <= 768) {
        const navMenuLinks = document.querySelectorAll(".nav-menu a");
        navMenuLinks.forEach((link) => {
          link.addEventListener("click", () => {
            // Close sidebar after a short delay to allow navigation
            setTimeout(() => {
              closeAllMobileSidebars();
            }, 100);
          });
        });
      }
    </script>
  </body>
</html>
