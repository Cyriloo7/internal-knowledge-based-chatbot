<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Chat - RAG Chatbot</title>
    <link
      rel="icon"
      type="image/svg+xml"
      href="{{ url_for('static', filename='icons/favicon.svg') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
  </head>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <body>
    <div class="app-container">
      <nav class="sidebar">
        <div class="sidebar-header">
          <div class="logo-small" , style="width: 60px; height: 60px">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
              <rect x="2" y="28" width="6" height="12" rx="2" fill="#546E7A" />
              <rect x="56" y="28" width="6" height="12" rx="2" fill="#546E7A" />

              <rect x="6" y="10" width="52" height="46" rx="8" fill="#78909C" />

              <rect x="28" y="4" width="8" height="6" fill="#546E7A" />
              <circle cx="32" cy="4" r="4" fill="#EF5350" />

              <rect
                x="12"
                y="20"
                width="40"
                height="18"
                rx="4"
                fill="#263238"
              />

              <circle cx="24" cy="29" r="5" fill="#FFCA28" />
              <circle cx="40" cy="29" r="5" fill="#FFCA28" />

              <rect x="20" y="44" width="24" height="6" rx="1" fill="#263238" />
            </svg>
          </div>
          <h2>RAG Assistant</h2>
        </div>

        <ul class="nav-menu">
          <li>
            <a href="/dashboard">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <rect x="3" y="3" width="7" height="7"></rect>
                <rect x="14" y="3" width="7" height="7"></rect>
                <rect x="14" y="14" width="7" height="7"></rect>
                <rect x="3" y="14" width="7" height="7"></rect>
              </svg>
              Dashboard
            </a>
          </li>
          <li class="active">
            <a href="/chat">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
                ></path>
              </svg>
              Chat
            </a>
          </li>
          {% if user.role in ['b-manager', 'a-manager', 'admin'] %}
          <li>
            <a href="#" onclick="showUploadModal(); return false;">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
              </svg>
              Upload Documents
            </a>
          </li>
          {% endif %} {% if user.role == 'admin' %}
          <li>
            <a href="/admin">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M12 2a10 10 0 1 0 10 10H12V2z"></path>
              </svg>
              Admin Panel
            </a>
          </li>
          {% endif %}
        </ul>

        <div class="sidebar-footer">
          <div class="user-info">
            <div class="avatar">{{ user.username[0].upper() }}</div>
            <div>
              <div class="user-name">{{ user.username }}</div>
              <div class="user-role">{{ user.role }}</div>
            </div>
          </div>
          <a href="/logout" class="btn-logout">Logout</a>
        </div>
      </nav>

      <!-- Conversations Sidebar -->
      <aside class="conversations-sidebar" id="conversationsSidebar">
        <div class="conversations-header">
          <h3>Conversations</h3>
          <button
            class="btn-new-conversation"
            id="newConversationBtn"
            title="New Conversation"
          >
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
          </button>
        </div>
        <div class="conversations-list" id="conversationsList">
          <!-- Conversations will be loaded here -->
        </div>
      </aside>

      <main class="chat-container">
        <div class="chat-header">
          <div>
            <h1>Document Q&A</h1>
            <div class="status-badge-small" id="connectionStatus">
              <span class="status-dot status-online"></span>
              <span>Ready</span>
            </div>
          </div>
          <div class="collection-selector">
            <label for="collection">Collection:</label>
            <select id="collection">
              {% for level in collections %}
              <option value="{{ level }}">
                {% if level == 'level-1' %}Level 1 (General) {% elif level ==
                'level-2' %}Level 2 (Team) {% elif level == 'level-3' %}Level 3
                (Department) {% elif level == 'level-4' %}Level 4 (Organization)
                {% endif %}
              </option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="chat-messages" id="chatMessages">
          <div id="historySection"></div>
          <div id="newSection">
            <div class="message-system" id="welcomeMessage">
              <svg width="40" height="40" viewBox="0 0 60 60" fill="none">
                <rect width="60" height="60" rx="12" fill="#EEF2FF" />
                <path
                  d="M30 15L45 25V40L30 50L15 40V25L30 15Z"
                  stroke="#4F46E5"
                  stroke-width="3"
                  fill="none"
                />
                <circle cx="30" cy="30" r="8" fill="#4F46E5" />
              </svg>
              <div>
                <p><strong>Welcome to RAG Assistant!</strong></p>
                <p>
                  I can help you find information from your indexed documents.
                  Ask me anything about the documents you have access to.
                </p>
                <p class="help-text">
                  Try asking: "What are the main topics in the document?" or
                  "Summarize the key findings."
                </p>
              </div>
            </div>
          </div>
        </div>

        <div class="chat-input-container">
          <form id="chatForm">
            <textarea
              id="messageInput"
              placeholder="Ask a question about your documents..."
              rows="1"
              required
            ></textarea>
            <button type="submit" id="sendButton">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
              </svg>
            </button>
          </form>
        </div>
      </main>
    </div>

    <!-- Upload Modal -->
    {% if user.role in ['b-manager', 'a-manager', 'admin'] %}
    <div id="uploadModal" class="modal">
      <div class="modal-content">
        <span class="modal-close" onclick="closeUploadModal()">&times;</span>
        <h2>Upload Document</h2>
        <form id="uploadForm" enctype="multipart/form-data">
          <div class="form-group">
            <label for="pdfFile">Select Document (PDF, DOCX, PPT, TXT)</label>
            <input
              type="file"
              id="pdfFile"
              name="file"
              accept=".pdf,.docx,.doc,.ppt,.pptx,.txt"
              required
            />
            <small
              style="
                color: var(--text-light);
                font-size: 13px;
                margin-top: 4px;
                display: block;
              "
            >
              Supported formats: PDF, DOCX, PPT, PPTX, TXT
            </small>
          </div>
          <div class="form-group">
            <label for="collectionName">Collection Name</label>
            <select id="collectionName" name="collection_name" required>
              <option value="level-1">Level 1 (General)</option>

              {% if user.role in ['b-manager', 'a-manager', 'admin'] %}
              <option value="level-2">Level 2 (Team)</option>
              {% endif %} {% if user.role in ['a-manager', 'admin'] %}
              <option value="level-3">Level 3 (Department)</option>
              {% endif %} {% if user.role == 'admin' %}
              <option value="level-4">Level 4 (Organization)</option>
              {% endif %}
            </select>
          </div>
          <div id="uploadProgress" style="display: none">
            <div class="status-indicator">
              <div class="status-icon" id="statusIcon">
                <div class="spinner-small"></div>
              </div>
              <div class="status-text">
                <p id="uploadStatus" class="status-message">Processing...</p>
                <p id="uploadDetails" class="status-details"></p>
              </div>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill"></div>
            </div>
          </div>
          <button type="submit" class="btn btn-primary" id="uploadButton">
            Upload & Index
          </button>
        </form>
      </div>
    </div>
    {% endif %}

    <script>
      const chatMessages = document.getElementById('chatMessages');
      const chatForm = document.getElementById('chatForm');
      const messageInput = document.getElementById('messageInput');
      const sendButton = document.getElementById('sendButton');
      const collectionSelect = document.getElementById('collection');
      const conversationsList = document.getElementById('conversationsList');
      const newConversationBtn = document.getElementById('newConversationBtn');

      let currentConversationId = {% if current_conversation_id %}{{ current_conversation_id }}{% else %}null{% endif %};
      let isFirstMessage = !currentConversationId;

      // Load conversations list
      async function loadConversations() {
          try {
              const response = await fetch('/api/conversations');
              const conversations = await response.json();

              conversationsList.innerHTML = '';

              conversations.forEach(conv => {
                  const convItem = document.createElement('div');
                  convItem.className = `conversation-item ${conv.id === currentConversationId ? 'active' : ''}`;
                  convItem.dataset.conversationId = conv.id;
                  convItem.innerHTML = `
                      <div class="conversation-content">
                          <div class="conversation-title" data-conversation-id="${conv.id}">${escapeHtml(conv.title)}</div>
                          <div class="conversation-meta">${new Date(conv.updated_at).toLocaleDateString()}</div>
                      </div>
                      <div class="conversation-actions">
                          <button class="conversation-rename" onclick="event.stopPropagation(); startRename(${conv.id}, '${escapeHtml(conv.title)}')" title="Rename">
                              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                              </svg>
                          </button>
                          <button class="conversation-delete" onclick="event.stopPropagation(); deleteConversation(${conv.id})" title="Delete">
                              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                  <polyline points="3 6 5 6 21 6"></polyline>
                                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                              </svg>
                          </button>
                      </div>
                  `;

                  // Click to navigate
                  convItem.addEventListener('click', (e) => {
                      if (!e.target.closest('.conversation-actions')) {
                          window.location.href = `/chat?conversation_id=${conv.id}`;
                      }
                  });

                  // Double-click title to rename
                  const titleEl = convItem.querySelector('.conversation-title');
                  titleEl.addEventListener('dblclick', (e) => {
                      e.stopPropagation();
                      startRename(conv.id, conv.title);
                  });

                  conversationsList.appendChild(convItem);
              });
          } catch (error) {
              console.error('Failed to load conversations:', error);
          }
      }

      // Rename conversation
      function startRename(conversationId, currentTitle) {
          const titleElement = document.querySelector(`[data-conversation-id="${conversationId}"]`);
          if (!titleElement) return;

          const input = document.createElement('input');
          input.type = 'text';
          input.className = 'conversation-title-input';
          input.value = currentTitle;

          titleElement.replaceWith(input);
          input.focus();
          input.select();

          async function finishRename() {
              const newTitle = input.value.trim();
              if (newTitle && newTitle !== currentTitle) {
                  try {
                      const response = await fetch(`/api/conversations/${conversationId}`, {
                          method: 'PUT',
                          headers: {
                              'Content-Type': 'application/json',
                          },
                          body: JSON.stringify({ title: newTitle })
                      });

                      if (response.ok) {
                          loadConversations();
                      }
                  } catch (error) {
                      console.error('Failed to rename conversation:', error);
                  }
              } else {
                  loadConversations();
              }
          }

          input.addEventListener('blur', finishRename);
          input.addEventListener('keydown', (e) => {
              if (e.key === 'Enter') {
                  e.preventDefault();
                  input.blur();
              } else if (e.key === 'Escape') {
                  loadConversations();
              }
          });
      }

      // Create new conversation
      async function createNewConversation() {
          isFirstMessage = true;
          currentConversationId = null;

          // Clear the chat
          const newSection = document.getElementById('newSection');
          const welcomeMessage = document.getElementById('welcomeMessage');
          const existingMessages = newSection.querySelectorAll('.message, .conversation-separator');
          existingMessages.forEach(msg => {
              if (msg.id !== 'welcomeMessage') msg.remove();
          });
          if (welcomeMessage) {
              welcomeMessage.style.display = 'flex';
          }

          // Clear history section
          document.getElementById('historySection').innerHTML = '';

          // Update URL
          window.history.pushState({}, '', '/chat');

          // Reload conversations
          loadConversations();
      }

      // Delete conversation
      async function deleteConversation(conversationId) {
          if (!confirm('Are you sure you want to delete this conversation?')) {
              return;
          }

          try {
              const response = await fetch(`/api/conversations/${conversationId}`, {
                  method: 'DELETE'
              });

              if (response.ok) {
                  if (currentConversationId === conversationId) {
                      window.location.href = '/chat';
                  } else {
                      loadConversations();
                  }
              }
          } catch (error) {
              console.error('Failed to delete conversation:', error);
              alert('Failed to delete conversation');
          }
      }

      // Load conversation history on page load
      async function loadChatHistory() {
          const historySection = document.getElementById('historySection');
          const newSection = document.getElementById('newSection');
          const welcomeMessage = document.getElementById('welcomeMessage');

          try {
              const url = currentConversationId
                  ? `/api/chat-history?conversation_id=${currentConversationId}`
                  : `/api/chat-history?collection=${collectionSelect.value}`;

              const response = await fetch(url);
              const history = await response.json();

              historySection.innerHTML = '';

              if (history.length > 0) {
                  const separator = document.createElement('div');
                  separator.className = 'conversation-separator';
                  separator.innerHTML = `
                      <div class="separator-line"></div>
                      <div class="separator-text">Previous Conversation</div>
                      <div class="separator-line"></div>
                  `;
                  historySection.appendChild(separator);

                  history.forEach(item => {
                      addMessageToSection(item.message, true, historySection);
                      addMessageToSection(item.response, false, historySection);
                  });

                  if (welcomeMessage) {
                      welcomeMessage.style.display = 'none';
                  }

                  isFirstMessage = false;
              } else {
                  if (welcomeMessage) {
                      welcomeMessage.style.display = 'flex';
                  }
                  isFirstMessage = true;
              }

              chatMessages.scrollTop = chatMessages.scrollHeight;
          } catch (error) {
              console.error('Failed to load chat history:', error);
          }
      }

      // Add message to specific section
      function addMessageToSection(content, isUser = false, section) {
          const messageDiv = document.createElement('div');
          messageDiv.className = `message ${isUser ? 'message-user' : 'message-assistant'}`;

          if (isUser) {
              messageDiv.innerHTML = `
                  <div class="avatar-small">{{ user.username[0].upper() }}</div>
                  <div class="message-content">${escapeHtml(content)}</div>
              `;
          } else {
              messageDiv.innerHTML = `
                <svg width="32" height="32" viewBox="0 0 60 60" fill="none">
                    <rect width="60" height="60" rx="12" fill="#EEF2FF"/>
                    <path d="M30 15L45 25V40L30 50L15 40V25L30 15Z"
                          stroke="#4F46E5" stroke-width="3" fill="none"/>
                    <circle cx="30" cy="30" r="8" fill="#4F46E5"/>
                </svg>
                <div class="message-content markdown-content">
                    <button class="copy-btn" title="Copy response">ðŸ“‹</button>
                    <div class="assistant-text">
                        ${formatResponse(content)}
                    </div>
                </div>
              `;
          }

          section.appendChild(messageDiv);
      }

      collectionSelect.addEventListener('change', () => {
          const newSection = document.getElementById('newSection');
          const welcomeMessage = document.getElementById('welcomeMessage');
          const existingMessages = newSection.querySelectorAll('.message, .conversation-separator');
          existingMessages.forEach(msg => {
              if (msg.id !== 'welcomeMessage') msg.remove();
          });
          if (welcomeMessage) {
              welcomeMessage.style.display = 'flex';
          }
          loadChatHistory();
      });

      if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', loadChatHistory);
      } else {
          loadChatHistory();
      }

      messageInput.addEventListener('input', function() {
          this.style.height = 'auto';
          this.style.height = (this.scrollHeight) + 'px';
      });

      messageInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault();
              chatForm.dispatchEvent(new Event('submit'));
          }
      });

      function addMessage(content, isUser = false) {
          const newSection = document.getElementById('newSection');
          const welcomeMessage = document.getElementById('welcomeMessage');

          if (welcomeMessage && welcomeMessage.style.display !== 'none') {
              welcomeMessage.style.display = 'none';
          }

          if (newSection.querySelectorAll('.message').length === 0 &&
              document.getElementById('historySection').querySelectorAll('.message').length > 0) {
              const separator = document.createElement('div');
              separator.className = 'conversation-separator';
              separator.innerHTML = `
                  <div class="separator-line"></div>
                  <div class="separator-text">New Conversation</div>
                  <div class="separator-line"></div>
              `;
              newSection.appendChild(separator);
          }

          const messageDiv = document.createElement('div');
          messageDiv.className = `message ${isUser ? 'message-user' : 'message-assistant'}`;

          if (isUser) {
              messageDiv.innerHTML = `
                  <div class="avatar-small">{{ user.username[0].upper() }}</div>
                  <div class="message-content">${escapeHtml(content)}</div>
              `;
          } else {
              messageDiv.innerHTML = `
                <svg width="32" height="32" viewBox="0 0 60 60" fill="none">
                    <rect width="60" height="60" rx="12" fill="#EEF2FF"/>
                    <path d="M30 15L45 25V40L30 50L15 40V25L30 15Z"
                          stroke="#4F46E5" stroke-width="3" fill="none"/>
                    <circle cx="30" cy="30" r="8" fill="#4F46E5"/>
                </svg>
                <div class="message-content markdown-content">
                    <button class="copy-btn" title="Copy response">ðŸ“‹</button>
                    <div class="assistant-text">
                        ${formatResponse(content)}
                    </div>
                </div>
              `;
          }

          newSection.appendChild(messageDiv);
          chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function addLoadingMessage() {
          const newSection = document.getElementById('newSection');
          const loadingDiv = document.createElement('div');
          loadingDiv.className = 'message message-assistant message-loading';
          loadingDiv.id = 'loadingMessage';
          loadingDiv.innerHTML = `
              <svg width="32" height="32" viewBox="0 0 60 60" fill="none">
                  <rect width="60" height="60" rx="12" fill="#EEF2FF"/>
                  <path d="M30 15L45 25V40L30 50L15 40V25L30 15Z" stroke="#4F46E5" stroke-width="3" fill="none"/>
                  <circle cx="30" cy="30" r="8" fill="#4F46E5"/>
              </svg>
              <div class="message-content">
                  <div class="typing-indicator">
                      <span></span><span></span><span></span>
                  </div>
              </div>
          `;
          newSection.appendChild(loadingDiv);
          chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function removeLoadingMessage() {
          const loading = document.getElementById('loadingMessage');
          if (loading) loading.remove();
      }

      function formatResponse(text) {
          const html = marked.parse(text, {
              breaks: true,
              gfm: true
          });
          return html;
      }

      function escapeHtml(text) {
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
      }

      function updateConnectionStatus(status) {
          const statusEl = document.getElementById('connectionStatus');
          const dot = statusEl.querySelector('.status-dot');
          const text = statusEl.querySelector('span:last-child');

          statusEl.className = 'status-badge-small';
          dot.className = 'status-dot';

          if (status === 'ready') {
              dot.classList.add('status-online');
              text.textContent = 'Ready';
          } else if (status === 'processing') {
              dot.classList.add('status-processing');
              text.textContent = 'Processing...';
          } else if (status === 'error') {
              dot.classList.add('status-error');
              text.textContent = 'Error';
          }
      }

      // Handle form submission
      chatForm.addEventListener('submit', async (e) => {
          e.preventDefault();

          const message = messageInput.value.trim();
          if (!message) return;

          const collection = collectionSelect.value;

          addMessage(message, true);
          messageInput.value = '';
          messageInput.style.height = 'auto';

          addLoadingMessage();
          sendButton.disabled = true;
          updateConnectionStatus('processing');

          try {
              const response = await fetch('/api/chat', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      message: message,
                      collection: collection,
                      conversation_id: currentConversationId,
                      is_first_message: isFirstMessage
                  })
              });

              const data = await response.json();

              removeLoadingMessage();
              updateConnectionStatus('ready');

              if (response.ok) {
                  addMessage(data.response);

                  if (data.conversation_id && !currentConversationId) {
                      currentConversationId = data.conversation_id;
                      isFirstMessage = false;
                      window.history.pushState({}, '', `/chat?conversation_id=${data.conversation_id}`);
                      loadConversations();
                  }
              } else {
                  addMessage(`Error: ${data.error || 'Failed to get response'}`, false);
                  updateConnectionStatus('error');
                  setTimeout(() => updateConnectionStatus('ready'), 3000);
              }
          } catch (error) {
              removeLoadingMessage();
              addMessage('Error: Unable to connect to the server', false);
              updateConnectionStatus('error');
              setTimeout(() => updateConnectionStatus('ready'), 3000);
          } finally {
              sendButton.disabled = false;
              messageInput.focus();
          }
      });

      newConversationBtn.addEventListener('click', createNewConversation);
      loadConversations();

      function showUploadModal() {
          document.getElementById('uploadModal').style.display = 'flex';
      }

      function closeUploadModal() {
          document.getElementById('uploadModal').style.display = 'none';
      }

      {% if user.role in ['b-manager', 'a-manager', 'admin'] %}
      document.getElementById('uploadForm').addEventListener('submit', async (e) => {
          e.preventDefault();

          const formData = new FormData(e.target);
          const uploadProgress = document.getElementById('uploadProgress');
          const uploadStatus = document.getElementById('uploadStatus');
          const uploadDetails = document.getElementById('uploadDetails');
          const uploadButton = document.getElementById('uploadButton');
          const statusIcon = document.getElementById('statusIcon');

          uploadProgress.style.display = 'block';
          uploadButton.disabled = true;
          uploadButton.textContent = 'Processing...';

          uploadStatus.textContent = 'Processing file...';
          uploadDetails.textContent = 'Validating file format and preparing for upload';
          statusIcon.innerHTML = '<div class="spinner-small"></div>';

          try {
              uploadStatus.textContent = 'Uploading file...';
              uploadDetails.textContent = 'Transferring file to server';

              const response = await fetch('/api/upload', {
                  method: 'POST',
                  body: formData
              });

              const data = await response.json();

              if (response.ok) {
                  uploadStatus.textContent = 'Indexing document...';
                  uploadDetails.textContent = 'Extracting text, processing images, and creating embeddings';

                  await new Promise(resolve => setTimeout(resolve, 2000));

                  uploadStatus.textContent = 'Upload successful!';
                  uploadDetails.textContent = 'Document indexed and ready for queries';
                  statusIcon.innerHTML = 'âœ…';
                  uploadButton.textContent = 'Complete';

                  setTimeout(() => {
                      location.reload();
                  }, 2000);
              } else {
                  uploadStatus.textContent = `Error: ${data.error}`;
                  uploadDetails.textContent = 'Please try again or contact support';
                  statusIcon.innerHTML = 'âŒ';
                  uploadButton.disabled = false;
                  uploadButton.textContent = 'Upload & Index';
              }
          } catch (error) {
              uploadStatus.textContent = 'Error: Upload failed';
              uploadDetails.textContent = error.message || 'Network error. Please check your connection.';
              statusIcon.innerHTML = 'âŒ';
              uploadButton.disabled = false;
              uploadButton.textContent = 'Upload & Index';
          }
      });
      {% endif %}

      window.onclick = function(event) {
          const modal = document.getElementById('uploadModal');
          if (event.target == modal) {
              closeUploadModal();
          }
      }

      function fallbackCopyText(text) {
          const textarea = document.createElement('textarea');
          textarea.value = text;
          textarea.style.position = 'fixed';
          textarea.style.top = '0';
          textarea.style.left = '0';
          document.body.appendChild(textarea);
          textarea.focus();
          textarea.select();

          try {
              document.execCommand('copy');
          } catch (err) {
              console.error('Fallback copy failed', err);
          }

          document.body.removeChild(textarea);
      }

      chatMessages.addEventListener('click', async (e) => {
          const copyBtn = e.target.closest('.copy-btn');
          if (!copyBtn) return;

          const assistantText = copyBtn
              .closest('.message-content')
              .querySelector('.assistant-text');

          if (!assistantText) return;

          const textToCopy = assistantText.innerText;

          try {
              await navigator.clipboard.writeText(textToCopy);
          } catch (err) {
              fallbackCopyText(textToCopy);
          }

          const original = copyBtn.innerText;
          copyBtn.innerText = 'âœ…';
          setTimeout(() => {
              copyBtn.innerText = original;
          }, 1200);
      });
    </script>
  </body>
</html>
