<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - benbot</title>
    <link
      rel="icon"
      type="image/svg+xml"
      href="{{ url_for('static', filename='icons/favicon.svg') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
  </head>
  <body>
    <div class="app-container">
      <nav class="sidebar">
        <div class="sidebar-header">
          <div class="sidebar-header-content">
            <div class="logo-small" , style="width: 60px; height: 60px">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
                <rect x="2" y="28" width="6" height="12" rx="2" fill="#546E7A" />
                <rect x="56" y="28" width="6" height="12" rx="2" fill="#546E7A" />

                <rect x="6" y="10" width="52" height="46" rx="8" fill="#78909C" />

                <rect x="28" y="4" width="8" height="6" fill="#546E7A" />
                <circle cx="32" cy="4" r="4" fill="#EF5350" />

                <rect
                  x="12"
                  y="20"
                  width="40"
                  height="18"
                  rx="4"
                  fill="#263238"
                />

                <circle cx="24" cy="29" r="5" fill="#FFCA28" />
                <circle cx="40" cy="29" r="5" fill="#FFCA28" />

                <rect x="20" y="44" width="24" height="6" rx="1" fill="#263238" />
              </svg>
            </div>
            <h2>benbot</h2>
          </div>
          <button class="sidebar-toggle-btn" id="sidebarToggle" onclick="toggleSidebar()" title="Toggle sidebar">
            <svg
              id="sidebarToggleIcon"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <line x1="3" y1="12" x2="21" y2="12"></line>
              <line x1="3" y1="6" x2="21" y2="6"></line>
              <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
          </button>
        </div>

        <ul class="nav-menu">
          <li class="active">
            <a href="/dashboard" title="Dashboard">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <rect x="3" y="3" width="7" height="7"></rect>
                <rect x="14" y="3" width="7" height="7"></rect>
                <rect x="14" y="14" width="7" height="7"></rect>
                <rect x="3" y="14" width="7" height="7"></rect>
              </svg>
              <span>Dashboard</span>
            </a>
          </li>
          <li>
            <a href="/chat" title="Chat">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
                ></path>
              </svg>
              <span>Chat</span>
            </a>
          </li>
          {% if user.role in ['b-manager', 'a-manager', 'admin'] %}
          <li>
            <a href="/upload" title="Upload Documents">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
              </svg>
              <span>Upload Documents</span>
            </a>
          </li>
          {% endif %} {% if user.role == 'admin' %}
          <li>
            <a href="/admin" title="Admin Panel">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M12 2a10 10 0 1 0 10 10H12V2z"></path>
              </svg>
              <span>Admin Panel</span>
            </a>
          </li>
          {% endif %}
        </ul>

        <div class="sidebar-footer">
          <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="Toggle theme">
            <svg id="themeIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="5"></circle>
              <line x1="12" y1="1" x2="12" y2="3"></line>
              <line x1="12" y1="21" x2="12" y2="23"></line>
              <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
              <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
              <line x1="1" y1="12" x2="3" y2="12"></line>
              <line x1="21" y1="12" x2="23" y2="12"></line>
              <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
              <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
            </svg>
          </button>
          <div class="user-info">
            <div class="avatar">{{ user.username[0].upper() }}</div>
            <div>
              <div class="user-name">{{ user.username }}</div>
              <div class="user-role">{{ user.role }}</div>
            </div>
          </div>
          <a href="/logout" class="btn-logout">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <polyline points="16 17 21 12 16 7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            <span>Logout</span>
          </a>
        </div>
      </nav>

      <main class="main-content">
        <div class="page-header">
          <h1>Welcome, {{ user.username }}!</h1>
          <p>
            Your role:
            <span class="badge badge-{{ user.role }}">{{ user.role }}</span>
          </p>
        </div>

        <div class="dashboard-grid">
          <div class="card">
            <div class="card-icon" style="background: #eef2ff">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="#4F46E5"
                stroke-width="2"
              >
                <path
                  d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
                ></path>
              </svg>
            </div>
            <div class="card-content">
              <h3>Start Chatting</h3>
              <p>Ask questions about your documents with AI-powered search</p>
              <a href="/chat" class="btn btn-primary">Go to Chat</a>
            </div>
          </div>

          {% if user.role in ['b-manager', 'a-manager', 'admin'] %}
          <div class="card">
            <div class="card-icon" style="background: #f0fdf4">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="#16A34A"
                stroke-width="2"
              >
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
              </svg>
            </div>
            <div class="card-content">
              <h3>Upload Documents</h3>
              <p>Index new PDF documents for intelligent search</p>
              <a href="/chat" class="btn btn-secondary">Upload Now</a>
            </div>
          </div>
          {% endif %} {% if user.role == 'admin' %}
          <div class="card">
            <div class="card-icon" style="background: #fef2f2">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="#DC2626"
                stroke-width="2"
              >
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
              </svg>
            </div>
            <div class="card-content">
              <h3>Manage Users</h3>
              <p>Add, edit, and manage user accounts and permissions</p>
              <a href="/admin" class="btn btn-secondary">Admin Panel</a>
            </div>
          </div>
          {% endif %}

          <div class="card">
            <div class="card-icon" style="background: #fff7ed">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="#EA580C"
                stroke-width="2"
              >
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
              </svg>
            </div>
            <div class="card-content">
              <h3>How It Works</h3>
              <p>Learn about RAG technology and how to use the system</p>
              <button class="btn btn-secondary" onclick="showHelp()">
                Learn More
              </button>
            </div>
          </div>
        </div>

        <!-- Analytics Dashboard -->
        <div class="info-section">
          <h2>Analytics Dashboard</h2>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-card-header">
                <span class="stat-card-title">Total Conversations</span>
                <div class="stat-card-icon" style="background: var(--primary-light); color: var(--primary);">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                  </svg>
                </div>
              </div>
              <div class="stat-card-value">{{ total_conversations }}</div>
              <div class="stat-card-change">All time</div>
            </div>
            
            <div class="stat-card">
              <div class="stat-card-header">
                <span class="stat-card-title">Total Messages</span>
                <div class="stat-card-icon" style="background: var(--secondary-light); color: var(--secondary);">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                  </svg>
                </div>
              </div>
              <div class="stat-card-value">{{ total_messages }}</div>
              <div class="stat-card-change">All time</div>
            </div>
            
            <div class="stat-card">
              <div class="stat-card-header">
                <span class="stat-card-title">Recent Activity</span>
                <div class="stat-card-icon" style="background: var(--warning-light); color: var(--warning);">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                  </svg>
                </div>
              </div>
              <div class="stat-card-value">{{ recent_messages }}</div>
              <div class="stat-card-change">Last 7 days</div>
            </div>
          </div>
          
          <div class="analytics-charts">
            <div class="chart-card">
              <div class="chart-header">
                <div>
                  <h3>Activity Over Time</h3>
                  <p class="chart-subtitle">Your message activity for the last 30 days</p>
                </div>
                <div class="chart-legend">
                  <div class="legend-item">
                    <span class="legend-color" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></span>
                    <span>Messages</span>
                  </div>
                </div>
              </div>
              <div class="chart-container">
                <canvas id="activityChart"></canvas>
                <div id="chartTooltip" class="chart-tooltip"></div>
              </div>
              <div class="chart-footer">
                <div class="chart-stats">
                  <div class="chart-stat-item">
                    <span class="stat-label">Total Messages</span>
                    <span class="stat-value" id="totalMessagesStat">-</span>
                  </div>
                  <div class="chart-stat-item">
                    <span class="stat-label">Average/Day</span>
                    <span class="stat-value" id="avgMessagesStat">-</span>
                  </div>
                  <div class="chart-stat-item">
                    <span class="stat-label">Peak Day</span>
                    <span class="stat-value" id="peakDayStat">-</span>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="chart-card">
              <h3>Collection Usage</h3>
              <div id="collectionChart" class="collection-chart">
                {% for stat in collection_stats %}
                <div class="collection-bar-item">
                  <div class="collection-bar-label">{{ stat.collection_name }}</div>
                  <div class="collection-bar">
                    <div class="collection-bar-fill" style="width: {{ (stat.count / total_messages * 100) if total_messages > 0 else 0 }}%"></div>
                    <span class="collection-bar-value">{{ stat.count }}</span>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>

        <div class="info-section">
          <h2>Access Levels</h2>
          <div class="access-grid">
            <div
              class="access-card {% if user.role == 'user' %}active{% endif %}"
            >
              <div class="access-header">User</div>
              <ul>
                <li>View and search basic documents</li>
                <li>Chat with AI assistant</li>
                <li>Access personal chat history</li>
              </ul>
            </div>
            <div
              class="access-card {% if user.role == 'b-manager' %}active{% endif %}"
            >
              <div class="access-header">B-Manager</div>
              <ul>
                <li>All User permissions</li>
                <li>Upload new documents</li>
                <li>Access B-level documents</li>
              </ul>
            </div>
            <div
              class="access-card {% if user.role == 'a-manager' %}active{% endif %}"
            >
              <div class="access-header">A-Manager</div>
              <ul>
                <li>All B-Manager permissions</li>
                <li>Access A-level documents</li>
                <li>View team analytics</li>
              </ul>
            </div>
            <div
              class="access-card {% if user.role == 'admin' %}active{% endif %}"
            >
              <div class="access-header">Admin</div>
              <ul>
                <li>Full system access</li>
                <li>Manage all users</li>
                <li>Configure system settings</li>
              </ul>
            </div>
          </div>
        </div>
      </main>

      <!-- Mobile Overlay -->
      <div
        class="mobile-overlay"
        id="mobileOverlay"
        onclick="closeAllMobileSidebars()"
      ></div>

      <!-- Mobile Bottom Navigation -->
      <nav class="mobile-bottom-nav">
        <a
          href="/dashboard"
          class="mobile-bottom-nav-item active"
          id="mobileNavDashboard"
        >
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <rect x="3" y="3" width="7" height="7"></rect>
            <rect x="14" y="3" width="7" height="7"></rect>
            <rect x="14" y="14" width="7" height="7"></rect>
            <rect x="3" y="14" width="7" height="7"></rect>
          </svg>
          <span>Dashboard</span>
        </a>
        <a
          href="/chat"
          class="mobile-bottom-nav-item"
          id="mobileNavChat"
        >
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
            ></path>
          </svg>
          <span>Chat</span>
        </a>
        <button
          class="mobile-bottom-nav-item"
          id="mobileNavMenu"
          onclick="toggleMobileSidebar()"
          style="border: none; background: none; cursor: pointer; width: 100%"
        >
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
          </svg>
          <span>Menu</span>
        </button>
        {% if user.role == 'admin' %}
        <a
          href="/admin"
          class="mobile-bottom-nav-item"
          id="mobileNavAdmin"
        >
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
            <path d="M2 17l10 5 10-5"></path>
            <path d="M2 12l10 5 10-5"></path>
          </svg>
          <span>Admin</span>
        </a>
        {% endif %}
      </nav>
    </div>

    <script>
      // Theme Management
      function initTheme() {
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        updateThemeIcon(savedTheme);
      }

      function toggleTheme() {
        const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeIcon(newTheme);
      }

      function updateThemeIcon(theme) {
        const icon = document.getElementById('themeIcon');
        if (!icon) return;
        
        if (theme === 'dark') {
          icon.innerHTML = `
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
          `;
        } else {
          icon.innerHTML = `
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
          `;
        }
      }

      // Sidebar Toggle Management
      function initSidebar() {
        const savedState = localStorage.getItem('sidebarCollapsed');
        const sidebar = document.querySelector('.sidebar');
        if (savedState === 'true' && sidebar) {
          sidebar.classList.add('collapsed');
        }
      }

      // Initialize theme and sidebar on page load
      initTheme();
      initSidebar();

      function showHelp() {
        alert(
          "RAG (Retrieval-Augmented Generation) combines document search with AI to provide accurate, context-aware answers.\n\n1. Upload PDF documents\n2. System indexes them with embeddings\n3. Ask questions in natural language\n4. AI retrieves relevant context and generates answers"
        );
      }

      // Load analytics chart
      async function loadAnalyticsChart() {
          try {
              const response = await fetch('/api/analytics');
              const data = await response.json();
              
              const canvas = document.getElementById('activityChart');
              if (!canvas) return;
              
              const container = canvas.parentElement;
              const containerWidth = container.clientWidth - 40;
              const containerHeight = 300;
              
              // Set canvas size
              canvas.width = containerWidth;
              canvas.height = containerHeight;
              
              const ctx = canvas.getContext('2d');
              const width = canvas.width;
              const height = canvas.height;
              
              // Clear canvas
              ctx.clearRect(0, 0, width, height);
              
              if (!data.daily_stats || data.daily_stats.length === 0) {
                  // Better empty state
                  ctx.fillStyle = 'var(--text-light)';
                  ctx.font = '16px sans-serif';
                  ctx.textAlign = 'center';
                  ctx.fillText('No activity data available', width / 2, height / 2 - 10);
                  ctx.font = '14px sans-serif';
                  ctx.fillStyle = 'var(--text-lighter)';
                  ctx.fillText('Start chatting to see your activity here', width / 2, height / 2 + 15);
                  
                  // Update stats
                  document.getElementById('totalMessagesStat').textContent = '0';
                  document.getElementById('avgMessagesStat').textContent = '0';
                  document.getElementById('peakDayStat').textContent = 'N/A';
                  return;
              }
              
              // Calculate stats
              const totalMessages = data.daily_stats.reduce((sum, stat) => sum + stat.count, 0);
              const avgMessages = Math.round((totalMessages / data.daily_stats.length) * 10) / 10;
              const peakDayData = data.daily_stats.reduce((max, stat) => stat.count > max.count ? stat : max, data.daily_stats[0]);
              const peakDate = new Date(peakDayData.date);
              const peakDayFormatted = peakDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
              
              // Update stats
              document.getElementById('totalMessagesStat').textContent = totalMessages.toLocaleString();
              document.getElementById('avgMessagesStat').textContent = avgMessages.toLocaleString();
              document.getElementById('peakDayStat').textContent = peakDayFormatted + ' (' + peakDayData.count + ')';
              
              // Chart dimensions
              const padding = { top: 50, right: 20, bottom: 60, left: 50 };
              const chartWidth = width - padding.left - padding.right;
              const chartHeight = height - padding.top - padding.bottom;
              
              const maxCount = Math.max(...data.daily_stats.map(d => d.count), 1);
              const barSpacing = 2;
              const barWidth = Math.max(4, (chartWidth / data.daily_stats.length) - barSpacing);
              
              // Draw grid lines
              ctx.strokeStyle = 'var(--border)';
              ctx.lineWidth = 1;
              const gridLines = 5;
              for (let i = 0; i <= gridLines; i++) {
                  const y = padding.top + (chartHeight / gridLines) * i;
                  ctx.beginPath();
                  ctx.moveTo(padding.left, y);
                  ctx.lineTo(width - padding.right, y);
                  ctx.stroke();
                  
                  // Y-axis labels
                  const value = Math.round(maxCount - (maxCount / gridLines) * i);
                  ctx.fillStyle = 'var(--text-light)';
                  ctx.font = '11px sans-serif';
                  ctx.textAlign = 'right';
                  ctx.fillText(value.toString(), padding.left - 10, y + 4);
              }
              
              // Draw Y-axis label
              ctx.save();
              ctx.translate(15, height / 2);
              ctx.rotate(-Math.PI / 2);
              ctx.fillStyle = 'var(--text)';
              ctx.font = '12px sans-serif';
              ctx.textAlign = 'center';
              ctx.fillText('Messages', 0, 0);
              ctx.restore();
              
              // Draw bars with gradient
              const gradient = ctx.createLinearGradient(0, padding.top, 0, height - padding.bottom);
              gradient.addColorStop(0, '#667eea');
              gradient.addColorStop(1, '#764ba2');
              
              data.daily_stats.forEach((stat, index) => {
                  const barHeight = maxCount > 0 ? (stat.count / maxCount) * chartHeight : 0;
                  const x = padding.left + index * (barWidth + barSpacing);
                  const y = padding.top + chartHeight - barHeight;
                  
                  // Draw bar with rounded corners effect
                  ctx.fillStyle = stat.count > 0 ? gradient : 'var(--border)';
                  ctx.fillRect(x, y, barWidth, barHeight);
                  
                  // Add hover effect (lighter color on top)
                  if (stat.count > 0) {
                      const highlightGradient = ctx.createLinearGradient(x, y, x, y + Math.min(barHeight, 20));
                      highlightGradient.addColorStop(0, 'rgba(255, 255, 255, 0.3)');
                      highlightGradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
                      ctx.fillStyle = highlightGradient;
                      ctx.fillRect(x, y, barWidth, Math.min(barHeight, 20));
                  }
                  
                  // Draw value on top of bar
                  if (stat.count > 0) {
                      ctx.fillStyle = 'var(--text)';
                      ctx.font = 'bold 12px sans-serif';
                      ctx.textAlign = 'center';
                      ctx.fillText(stat.count.toString(), x + barWidth / 2, y - 8);
                  }
                  
                  // Draw date label (rotate every 5 days or so to avoid crowding)
                  const date = new Date(stat.date);
                  const dayLabel = date.getDate();
                  const monthLabel = date.toLocaleDateString('en-US', { month: 'short' });
                  
                  ctx.fillStyle = 'var(--text-light)';
                  ctx.font = '10px sans-serif';
                  ctx.textAlign = 'center';
                  
                  // Show full date for first, last, and every 5th item
                  if (index === 0 || index === data.daily_stats.length - 1 || index % 5 === 0) {
                      ctx.fillText(monthLabel, x + barWidth / 2, height - padding.bottom + 15);
                      ctx.fillText(dayLabel.toString(), x + barWidth / 2, height - padding.bottom + 28);
                  } else {
                      ctx.fillText(dayLabel.toString(), x + barWidth / 2, height - padding.bottom + 20);
                  }
                  
                  // Store bar position for hover
                  canvas.barPositions = canvas.barPositions || [];
                  canvas.barPositions.push({
                      x: x,
                      y: y,
                      width: barWidth,
                      height: barHeight,
                      date: stat.date,
                      count: stat.count
                  });
              });
              
              // Add hover interaction
              const tooltip = document.getElementById('chartTooltip');
              canvas.addEventListener('mousemove', (e) => {
                  const rect = canvas.getBoundingClientRect();
                  const x = e.clientX - rect.left;
                  const y = e.clientY - rect.top;
                  
                  if (canvas.barPositions) {
                      const hoveredBar = canvas.barPositions.find(bar => 
                          x >= bar.x && x <= bar.x + bar.width &&
                          y >= bar.y && y <= height - padding.bottom
                      );
                      
                      if (hoveredBar && hoveredBar.count > 0) {
                          canvas.style.cursor = 'pointer';
                          const date = new Date(hoveredBar.date);
                          const dateStr = date.toLocaleDateString('en-US', { 
                              weekday: 'short', 
                              month: 'short', 
                              day: 'numeric',
                              year: 'numeric'
                          });
                          tooltip.innerHTML = `
                              <div class="tooltip-date">${dateStr}</div>
                              <div class="tooltip-value">${hoveredBar.count} message${hoveredBar.count !== 1 ? 's' : ''}</div>
                          `;
                          tooltip.style.display = 'block';
                          tooltip.style.left = (e.clientX - rect.left + 10) + 'px';
                          tooltip.style.top = (e.clientY - rect.top - 60) + 'px';
                      } else {
                          canvas.style.cursor = 'default';
                          tooltip.style.display = 'none';
                      }
                  }
              });
              
              canvas.addEventListener('mouseleave', () => {
                  tooltip.style.display = 'none';
                  canvas.style.cursor = 'default';
              });
              
          } catch (error) {
              console.error('Failed to load analytics:', error);
              const canvas = document.getElementById('activityChart');
              if (canvas) {
                  const ctx = canvas.getContext('2d');
                  ctx.fillStyle = 'var(--danger)';
                  ctx.font = '14px sans-serif';
                  ctx.textAlign = 'center';
                  ctx.fillText('Failed to load chart data', canvas.width / 2, canvas.height / 2);
              }
          }
      }

      // Load chart on page load
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadAnalyticsChart);
      } else {
        loadAnalyticsChart();
      }

      // Mobile sidebar functions
      function toggleMobileSidebar() {
        const sidebar = document.querySelector('.sidebar');
        const overlay = document.getElementById('mobileOverlay');

        if (!sidebar) {
          console.error('Sidebar element not found');
          return;
        }

        if (window.innerWidth <= 768) {
          const isOpening = !sidebar.classList.contains('open');

          // Remove collapsed class on mobile to ensure full width
          sidebar.classList.remove('collapsed');

          // Toggle open class
          sidebar.classList.toggle('open');

          // Show/hide overlay
          if (overlay) {
            if (isOpening) {
              overlay.classList.add('active');
            } else {
              overlay.classList.remove('active');
            }
          }

          // Force sidebar to be visible
          sidebar.style.display = 'flex';
          sidebar.style.visibility = 'visible';
          sidebar.style.opacity = '1';
        }
      }

      function closeAllMobileSidebars() {
        const sidebar = document.querySelector('.sidebar');
        const overlay = document.getElementById('mobileOverlay');

        if (sidebar) sidebar.classList.remove('open');
        if (overlay) overlay.classList.remove('active');
      }

      // Update active state in mobile bottom nav
      function updateMobileNavActive() {
        const currentPath = window.location.pathname;
        const navItems = document.querySelectorAll('.mobile-bottom-nav-item');
        navItems.forEach((item) => {
          item.classList.remove('active');
          if (item.getAttribute('href') === currentPath) {
            item.classList.add('active');
          }
        });
      }

      // Update mobile nav on page load
      updateMobileNavActive();

      // Prevent body scroll when sidebar is open on mobile
      function updateBodyScroll() {
        if (window.innerWidth <= 768) {
          const sidebar = document.querySelector('.sidebar');
          const isOpen = sidebar?.classList.contains('open');

          if (isOpen) {
            document.body.classList.add('sidebar-open');
          } else {
            document.body.classList.remove('sidebar-open');
          }
        } else {
          document.body.classList.remove('sidebar-open');
        }
      }

      // Watch for sidebar state changes
      const sidebarObserver = new MutationObserver(updateBodyScroll);
      const sidebar = document.querySelector('.sidebar');

      if (sidebar) {
        sidebarObserver.observe(sidebar, {
          attributes: true,
          attributeFilter: ['class'],
        });
      }

      // Desktop sidebar toggle
      function toggleSidebar() {
        const sidebar = document.querySelector('.sidebar');
        if (!sidebar) return;

        // Mobile handling
        if (window.innerWidth <= 768) {
          toggleMobileSidebar();
          return;
        }

        // Desktop handling
        sidebar.classList.toggle('collapsed');
        const isCollapsed = sidebar.classList.contains('collapsed');
        localStorage.setItem('sidebarCollapsed', isCollapsed);
      }

      // Close sidebar when clicking on nav menu items on mobile
      if (window.innerWidth <= 768) {
        const navMenuLinks = document.querySelectorAll('.nav-menu a');
        navMenuLinks.forEach(link => {
          link.addEventListener('click', () => {
            // Close sidebar after a short delay to allow navigation
            setTimeout(() => {
              closeAllMobileSidebars();
            }, 100);
          });
        });
      }
    </script>
  </body>
</html>
